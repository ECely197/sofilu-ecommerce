<header class="page-header">
  <h1>Plantillas de Variantes</h1>
</header>

<div class="templates-layout">
  <!-- COLUMNA IZQUIERDA: FORMULARIO -->
  <div class="form-column">
    <div class="card glass-panel sticky-card">
      <h2 class="card-title">
        {{ editingTemplateId() ? "Editar Plantilla" : "Crear Nueva Plantilla" }}
      </h2>

      <form [formGroup]="templateForm" (ngSubmit)="handleSubmit()">
        <!-- Nombre de la Plantilla -->
        <div class="material-field">
          <input
            id="templateName"
            type="text"
            formControlName="templateName"
            class="material-input"
            placeholder=" "
          />
          <label for="templateName" class="material-label"
            >Nombre de la Plantilla (ej. Tallas Camisetas)</label
          >
        </div>

        <!-- Nombre de la Variante -->
        <div class="material-field">
          <input
            id="variantName"
            type="text"
            formControlName="variantName"
            class="material-input"
            placeholder=" "
          />
          <label for="variantName" class="material-label"
            >Nombre de la Variante (ej. Talla)</label
          >
        </div>

        <!-- OPCIONES DINÁMICAS -->
        <div class="options-section" formArrayName="options">
          <div class="section-header-row">
            <h3 class="section-subtitle">Opciones</h3>
            <button
              type="button"
              (click)="addOption()"
              class="btn-dashed small"
            >
              + Añadir Valor
            </button>
          </div>

          <div class="options-list">
            <!-- CABECERA DE TABLA (SOLO DESKTOP) -->
            <div class="option-row header desktop-only-flex">
              <span class="col-img">Img</span>
              <span class="col-name">Valor</span>
              <span class="col-price">Precio (+)</span>
              <span class="col-stock">Stock</span>
              <span class="col-cost">Costo</span>
              <span class="col-action"></span>
            </div>

            <!-- FILAS DE OPCIONES -->
            @for (option of options.controls; track option; let i = $index) {
              <div class="option-row item" [formGroupName]="i">
                <!-- 1. Imagen (Mini Uploader) -->
                <div class="col-img" data-label="Imagen">
                  <label [for]="'opt-img-' + i" class="mini-uploader">
                    @if (option.get("imagePreview")?.value) {
                      <img
                        [src]="option.get('imagePreview')?.value"
                        class="preview"
                      />
                    } @else {
                      <span class="material-symbols-outlined icon"
                        >add_photo_alternate</span
                      >
                    }
                    <input
                      [id]="'opt-img-' + i"
                      type="file"
                      (change)="onOptionImageSelected($event, i)"
                      accept="image/*"
                      hidden
                    />
                  </label>
                </div>

                <!-- 2. Nombre (Valor) -->
                <div class="col-name" data-label="Valor">
                  <input
                    type="text"
                    formControlName="name"
                    class="simple-input"
                    placeholder="Ej: Rojo / XL"
                  />
                </div>

                <!-- 3. Precio -->
                <div class="col-price" data-label="Modificador Precio">
                  <input
                    type="number"
                    formControlName="price"
                    class="simple-input"
                    placeholder="0"
                  />
                </div>

                <!-- 4. Stock -->
                <div class="col-stock" data-label="Stock">
                  <input
                    type="number"
                    formControlName="stock"
                    class="simple-input"
                    placeholder="0"
                  />
                </div>

                <!-- 5. Costo -->
                <div class="col-cost" data-label="Costo">
                  <input
                    type="number"
                    formControlName="costPrice"
                    class="simple-input"
                    placeholder="0"
                  />
                </div>

                <!-- 6. Eliminar -->
                <div class="col-action">
                  <button
                    type="button"
                    (click)="removeOption(i)"
                    class="btn-icon delete"
                    [disabled]="options.length <= 1"
                  >
                    <span class="material-symbols-outlined">close</span>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- ACCIONES -->
        <div class="form-actions">
          @if (editingTemplateId()) {
            <button
              type="button"
              (click)="cancelEditing()"
              class="btn-secondary"
            >
              Cancelar
            </button>
          }
          <button
            type="submit"
            [disabled]="templateForm.invalid || isSaving()"
            class="btn-material full-width"
          >
            {{ isSaving() ? "Guardando..." : "Guardar Plantilla" }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- COLUMNA DERECHA: LISTA -->
  <div class="list-column">
    <div class="card glass-panel">
      <h2 class="card-title">Plantillas Guardadas</h2>

      @if (isLoading()) {
        <div class="loading-state"><div class="spinner"></div></div>
      } @else {
        <div class="templates-grid">
          @for (template of templates(); track template._id) {
            <div class="template-card">
              <div class="card-header">
                <span class="template-name">{{ template.templateName }}</span>
                <div class="actions">
                  <button
                    (click)="startEditing(template)"
                    class="btn-icon edit"
                  >
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button
                    (click)="deleteTemplate(template)"
                    class="btn-icon delete"
                  >
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </div>
              </div>

              <div class="card-body">
                <span class="label">{{ template.variantName }}:</span>
                <p class="values">{{ getOptionNames(template.options) }}</p>
              </div>
            </div>
          } @empty {
            <div class="empty-state">No hay plantillas.</div>
          }
        </div>
      }
    </div>
  </div>
</div>
