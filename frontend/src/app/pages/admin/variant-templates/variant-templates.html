<header class="page-header">
  <h1>Plantillas de Variantes</h1>
</header>

<div class="templates-layout">
  <!-- ============================================= -->
  <!-- Columna del Formulario de Creación -->
  <!-- ============================================= -->
  <div class="form-column">
    <div class="card">
      <h2 class="card-title">Crear Nueva Plantilla</h2>
      <form [formGroup]="templateForm" (ngSubmit)="handleSubmit()">
        <div class="material-field">
          <input
            id="templateName"
            type="text"
            formControlName="templateName"
            class="material-input"
            placeholder=" "
          />
          <label for="templateName" class="material-label"
            >Nombre de la Plantilla (ej. Tallas de Ropa)</label
          >
        </div>

        <div class="material-field">
          <input
            id="variantName"
            type="text"
            formControlName="variantName"
            class="material-input"
            placeholder=" "
          />
          <label for="variantName" class="material-label"
            >Nombre de la Variante (ej. Talla)</label
          >
        </div>

        <div class="options-group" formArrayName="options">
          <label class="options-label">Opciones</label>

          <!-- Cabecera de la tabla (SOLO VISIBLE EN ESCRITORIO) -->
          <div class="option-row header">
            <span>Valor</span>
            <span>Imagen</span>
            <span>Mod. Precio</span>
            <span>Stock</span>
            <span>Costo</span>
            <span></span>
          </div>

          <!-- Filas/Tarjetas de opciones dinámicas -->
          @for (option of options.controls; track option; let i = $index) {
          <!-- ¡CAMBIO CLAVE! Cada opción es ahora una tarjeta con su propio layout interno en móvil -->
          <div class="option-row" [formGroupName]="i">
            <!-- Cada input ahora tiene su propio label visible en móvil -->
            <div class="form-cell" data-label="Valor">
              <input
                type="text"
                formControlName="name"
                class="form-input"
                placeholder="Nombre"
              />
            </div>

            <div class="form-cell" data-label="Imagen">
              <div class="variant-image-uploader">
                <label [for]="'option-image-' + i" class="uploader-label">
                  @if (option.get('imagePreview')?.value) {
                  <img
                    [src]="option.get('imagePreview')?.value"
                    alt="Vista previa"
                    class="variant-image-preview"
                  />
                  } @else {
                  <span class="material-symbols-outlined placeholder-icon"
                    >add_photo_alternate</span
                  >
                  }
                </label>
                <input
                  [id]="'option-image-' + i"
                  type="file"
                  class="file-input"
                  (change)="onOptionImageSelected($event, i)"
                  accept="image/*"
                />
              </div>
            </div>

            <div class="form-cell" data-label="Mod. Precio">
              <input
                type="number"
                formControlName="price"
                class="form-input"
                placeholder="+ COP"
              />
            </div>

            <div class="form-cell" data-label="Stock">
              <input
                type="number"
                formControlName="stock"
                class="form-input"
                placeholder="Cantidad"
              />
            </div>

            <div class="form-cell" data-label="Costo">
              <input
                type="number"
                formControlName="costPrice"
                class="form-input"
                placeholder="Costo"
              />
            </div>

            <div class="form-cell action-cell">
              <button
                type="button"
                (click)="removeOption(i)"
                class="delete-button-tiny"
                [disabled]="options.controls.length <= 1"
              >
                ✖
              </button>
            </div>
          </div>
          }

          <button
            type="button"
            (click)="addOption()"
            class="add-button-tiny"
            appRipple
          >
            + Añadir valor
          </button>
        </div>

        <div class="form-actions">
          <button
            type="submit"
            [disabled]="templateForm.invalid || isSaving()"
            class="btn btn-primary"
            appRipple
          >
            {{ isSaving() ? "Guardando..." : "Guardar Plantilla" }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============================================= -->
  <!-- Columna de la Lista de Plantillas Existentes -->
  <!-- ============================================= -->
  <div class="list-column">
    <div class="card">
      <h2 class="card-title">Plantillas Existentes</h2>
      @if (isLoading()) {
      <p>Cargando...</p>
      } @else {
      <div class="templates-list">
        @for (template of templates(); track template._id) {
        <div class="template-item">
          <div class="template-info">
            <p class="template-name">{{ template.templateName }}</p>
            <p class="template-details">
              <strong>{{ template.variantName }}:</strong>
              {{ getOptionNames(template.options) }}
            </p>
          </div>
          <button
            (click)="startEditing(template)"
            class="action-button edit-btn"
          >
            <span class="material-symbols-outlined">edit</span>
          </button>
          <button
            (click)="deleteTemplate(template)"
            class="delete-button-small"
            appRipple
          >
            ✖
          </button>
        </div>
        } @empty {
        <p class="empty-message">No has creado ninguna plantilla todavía.</p>
        }
      </div>
      }
    </div>
  </div>
</div>
