<header class="page-header">
  <h1>Eventos Especiales (Banners)</h1>
</header>

<div class="events-layout">
  <!-- COLUMNA IZQUIERDA: FORMULARIO -->
  <div class="form-column">
    <div class="card glass-panel sticky-card">
      <h2 class="card-title">
        {{ editingEventId() ? "Editar Evento" : "Nuevo Evento" }}
      </h2>

      <form [formGroup]="eventForm" (ngSubmit)="handleSubmit()">
        <!-- Uploader de Imagen (Protagonista) -->
        <div class="form-section">
          <label class="section-label">Imagen del Banner (Escritorio)</label>
          <label class="image-uploader" for="banner-upload">
            @if (imagePreview()) {
              <img [src]="imagePreview()" class="image-preview" />
              <div class="overlay-hover">
                <span class="material-symbols-outlined">edit</span>
              </div>
            } @else {
              <div class="uploader-placeholder">
                <span class="material-symbols-outlined icon"
                  >add_photo_alternate</span
                >
                <span>Subir Imagen (1920x800 recomendado)</span>
              </div>
            }
            @if (isSaving() && !imagePreview()) {
              <div class="spinner-overlay"><div class="spinner"></div></div>
            }
            <input
              id="banner-upload"
              type="file"
              (change)="onFileSelected($event)"
              accept="image/*"
              hidden
            />
          </label>
        </div>

        <!-- Textos -->
        <div class="material-field">
          <input
            id="title"
            type="text"
            formControlName="title"
            class="material-input"
            placeholder=" "
          />
          <label for="title" class="material-label">Título Principal</label>
        </div>

        <div class="material-field">
          <input
            id="subtitle"
            type="text"
            formControlName="subtitle"
            class="material-input"
            placeholder=" "
          />
          <label for="subtitle" class="material-label"
            >Subtítulo (Opcional)</label
          >
        </div>

        <!-- Selector de Productos Vinculados -->
        <div class="form-section">
          <label class="section-label">Productos Vinculados (Carrusel)</label>
          <p class="helper-text">
            Selecciona los productos que aparecerán al dar clic en el banner.
          </p>

          <div
            class="products-selector custom-scroll"
            formArrayName="linkedProducts"
          >
            @if (allProducts().length > 0) {
              @for (
                product of allProducts();
                track product._id;
                let i = $index
              ) {
                <label
                  class="product-option"
                  [class.selected]="productCheckboxes.at(i).value"
                >
                  <input type="checkbox" [formControlName]="i" hidden />
                  <div class="checkbox-circle">
                    <span class="material-symbols-outlined check-icon"
                      >check</span
                    >
                  </div>
                  <img
                    [src]="product.images[0]"
                    [alt]="product.name"
                    class="prod-thumb"
                  />
                  <span class="prod-name">{{ product.name }}</span>
                </label>
              }
            } @else {
              <div class="empty-products">Cargando productos...</div>
            }
          </div>
        </div>

        <!-- Acciones -->
        <div class="form-actions">
          @if (editingEventId()) {
            <button type="button" (click)="resetForm()" class="btn-secondary">
              Cancelar
            </button>
          }
          <button
            type="submit"
            [disabled]="eventForm.invalid || isSaving()"
            class="btn-material full-width"
          >
            {{ isSaving() ? "Guardando..." : "Guardar Evento" }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- COLUMNA DERECHA: LISTA DE EVENTOS -->
  <div class="list-column">
    <div class="card glass-panel">
      <h2 class="card-title">Banners Activos</h2>

      @if (isLoading()) {
        <div class="loading-state"><div class="spinner"></div></div>
      } @else {
        <div class="events-grid">
          @for (event of events(); track event._id) {
            <div class="event-card" [class.active-banner]="event.isActive">
              <!-- Imagen Banner -->
              <div class="banner-preview">
                <img [src]="event.imageUrl" [alt]="event.title" />
                <div class="status-badge" [class.on]="event.isActive">
                  {{ event.isActive ? "Visible" : "Oculto" }}
                </div>
              </div>

              <!-- Info -->
              <div class="card-content">
                <h3 class="event-name">{{ event.title }}</h3>
                <p class="event-sub">{{ event.subtitle || "Sin subtítulo" }}</p>
                <div class="meta-info">
                  <span class="material-symbols-outlined">inventory_2</span>
                  {{ event.linkedProducts.length }} productos
                </div>
              </div>

              <!-- Acciones -->
              <div class="card-actions">
                <!-- Toggle Visibilidad -->
                <button
                  class="action-btn toggle"
                  [class.active]="event.isActive"
                  (click)="toggleActive(event._id)"
                  title="Cambiar Visibilidad"
                >
                  <span class="material-symbols-outlined">{{
                    event.isActive ? "visibility" : "visibility_off"
                  }}</span>
                </button>

                <button
                  (click)="startEditing(event)"
                  class="action-btn edit"
                  title="Editar"
                >
                  <span class="material-symbols-outlined">edit</span>
                </button>

                <button
                  (click)="deleteEvent(event._id)"
                  class="action-btn delete"
                  title="Eliminar"
                >
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </div>
            </div>
          } @empty {
            <div class="empty-state">
              <span class="material-symbols-outlined icon">campaign</span>
              <p>No hay eventos creados.</p>
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>
