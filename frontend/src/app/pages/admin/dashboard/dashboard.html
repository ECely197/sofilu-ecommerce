<header class="page-header">
  <h1>Dashboard</h1>
</header>

<!-- ======================== -->
<!-- SECCIÓN DE FILTROS -->
<!-- ======================== -->
<div class="card filters-card">
  <form [formGroup]="dateRangeForm" class="date-filters">
    <div class="filter-group">
      <label>Rango de Fechas:</label>
      <div class="date-inputs">
        <div class="input-wrapper">
          <input
            id="startDate"
            type="date"
            formControlName="startDate"
            class="modern-date-input"
          />
        </div>
        <span class="separator">hasta</span>
        <div class="input-wrapper">
          <input
            id="endDate"
            type="date"
            formControlName="endDate"
            class="modern-date-input"
          />
        </div>
      </div>
    </div>

    <div class="filter-group">
      <label>Filtros Rápidos:</label>
      <div class="quick-filters">
        <button
          type="button"
          class="quick-btn"
          (click)="applyDateFilter('day')"
          appRipple
        >
          Hoy
        </button>
        <button
          type="button"
          class="quick-btn"
          (click)="applyDateFilter('week')"
          appRipple
        >
          Esta Semana
        </button>
        <button
          type="button"
          class="quick-btn"
          (click)="applyDateFilter('month')"
          appRipple
        >
          Este Mes
        </button>
      </div>
    </div>
  </form>
</div>

<!-- ======================== -->
<!-- CONTENIDO DEL DASHBOARD -->
<!-- ======================== -->

<!-- 1. ESTADO DE CARGA -->
@if (isLoading()) {
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Analizando datos del negocio...</p>
  </div>
} @else {
  <!-- 2. DATOS CARGADOS (Estructura Corregida: @if anidado dentro del @else) -->
  @if (summary(); as data) {
    <div class="dashboard-content">
      <!-- FILA DE KPIs -->
      <div class="stats-grid">
        <div class="stat-card revenue">
          <div class="icon-circle">
            <span class="material-symbols-outlined">attach_money</span>
          </div>
          <div>
            <p class="label">Ingresos</p>
            <h3 class="value">
              {{
                data.sales.totalRevenue | currency: "COP" : "symbol" : "1.0-0"
              }}
            </h3>
          </div>
        </div>

        <div class="stat-card orders">
          <div class="icon-circle">
            <span class="material-symbols-outlined">shopping_bag</span>
          </div>
          <div>
            <p class="label">Pedidos</p>
            <h3 class="value">{{ data.sales.totalOrders }}</h3>
          </div>
        </div>

        <div class="stat-card ticket">
          <div class="icon-circle">
            <span class="material-symbols-outlined">receipt_long</span>
          </div>
          <div>
            <p class="label">Ticket Prom.</p>
            <h3 class="value">
              {{
                data.sales.avgOrderValue | currency: "COP" : "symbol" : "1.0-0"
              }}
            </h3>
          </div>
        </div>

        <div class="stat-card inventory">
          <div class="icon-circle">
            <span class="material-symbols-outlined">inventory_2</span>
          </div>
          <div>
            <p class="label">Inventario</p>
            <h3 class="value">
              {{
                data.inventory.totalValue | currency: "COP" : "symbol" : "1.0-0"
              }}
            </h3>
          </div>
        </div>
      </div>

      <!-- FILA DE GRÁFICOS -->
      <div class="charts-grid">
        <div class="card chart-card">
          <div class="card-header-row">
            <h3 class="card-title">Ventas por Categoría</h3>
          </div>
          <div class="chart-container pie-container">
            <canvas
              baseChart
              [type]="'pie'"
              [options]="pieChartOptions"
              [data]="pieChartData"
            ></canvas>
          </div>
        </div>

        <div class="card chart-card">
          <div class="card-header-row">
            <h3 class="card-title">Top 5 Productos</h3>
          </div>
          <div class="chart-container">
            <canvas
              baseChart
              [type]="'bar'"
              [options]="barChartOptions"
              [data]="barChartData"
            ></canvas>
          </div>
        </div>
      </div>

      <!-- FILAS DE TABLAS -->

      <!-- Pedidos Recientes -->
      <div class="card full-width">
        <div class="card-header-row">
          <h3 class="card-title">Pedidos Recientes</h3>
          <a routerLink="/admin/orders" class="btn-link">Ver todos</a>
        </div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th class="text-right">Total</th>
              </tr>
            </thead>
            <tbody>
              @for (order of data.recentOrders; track order._id) {
                <tr>
                  <td class="font-mono">
                    #{{ order._id.slice(-6).toUpperCase() }}
                  </td>
                  <td>{{ order.customerInfo.name }}</td>
                  <td>{{ order.createdAt | date: "shortDate" }}</td>
                  <td>
                    <span
                      class="status-badge"
                      [ngClass]="order.status.toLowerCase()"
                      >{{ order.status }}</span
                    >
                  </td>
                  <td class="text-right font-bold">
                    {{
                      order.totalAmount | currency: "COP" : "symbol" : "1.0-0"
                    }}
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="5" class="text-center">
                    No hay pedidos recientes.
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Rendimiento Vendedores -->
      <div class="card full-width">
        <h3 class="card-title">Rendimiento por Vendedor</h3>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th style="width: 50px">#</th>
                <th>Vendedor</th>
                <th class="text-center">Vendidos</th>
                <th class="text-right">Total</th>
              </tr>
            </thead>
            <tbody>
              @for (
                vendor of data.vendorPerformance;
                track vendor.vendorName;
                let i = $index
              ) {
                <tr>
                  <td>
                    <span class="rank">{{ i + 1 }}</span>
                  </td>
                  <td class="font-bold">{{ vendor.vendorName }}</td>
                  <td class="text-center">{{ vendor.totalProductsSold }}</td>
                  <td class="text-right">
                    {{
                      vendor.totalSalesValue
                        | currency: "COP" : "symbol" : "1.0-0"
                    }}
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="4" class="text-center">
                    Sin datos de vendedores.
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Rendimiento Cupones -->
      <div class="card full-width">
        <h3 class="card-title">Uso de Cupones</h3>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Código</th>
                <th class="text-center">Usos</th>
                <th class="text-right">Descuento Total</th>
              </tr>
            </thead>
            <tbody>
              @for (coupon of data.couponPerformance; track coupon._id) {
                <tr>
                  <td class="font-mono font-bold">{{ coupon._id }}</td>
                  <td class="text-center">{{ coupon.count }}</td>
                  <td class="text-right" style="color: #e11d48">
                    -{{
                      coupon.discountGiven
                        | currency: "COP" : "symbol" : "1.0-0"
                    }}
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="3" class="text-center">
                    No hay datos de cupones.
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  } @else {
    <!-- 3. ESTADO VACÍO (Data es null) -->
    <div class="empty-state">
      <p>No se encontraron datos para el periodo seleccionado.</p>
    </div>
  }
}
