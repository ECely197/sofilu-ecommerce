<header class="page-header">
  <h1>Dashboard</h1>
</header>

<!-- ======================== -->
<!-- SECCIÓN DE FILTROS -->
<!-- ======================== -->
<div class="card filters-card">
  <form [formGroup]="dateRangeForm" class="date-filters">
    <div class="date-inputs">
      <div class="form-field">
        <label for="startDate">Desde</label>
        <input
          id="startDate"
          type="date"
          formControlName="startDate"
          class="form-input"
        />
      </div>
      <div class="form-field">
        <label for="endDate">Hasta</label>
        <input
          id="endDate"
          type="date"
          formControlName="endDate"
          class="form-input"
        />
      </div>
    </div>
    <div class="quick-filters">
      <button
        type="button"
        class="quick-filter-btn"
        (click)="applyDateFilter('day')"
        appRipple
      >
        Hoy
      </button>
      <button
        type="button"
        class="quick-filter-btn"
        (click)="applyDateFilter('week')"
        appRipple
      >
        Esta Semana
      </button>
      <button
        type="button"
        class="quick-filter-btn"
        (click)="applyDateFilter('month')"
        appRipple
      >
        Este Mes
      </button>
      <button
        type="button"
        class="quick-filter-btn"
        (click)="applyDateFilter('year')"
        appRipple
      >
        Este Año
      </button>
    </div>
  </form>
</div>

<!-- ======================== -->
<!-- CONTENIDO DEL DASHBOARD -->
<!-- ======================== -->
@if (isLoading()) {
<div class="loading-state">Cargando estadísticas...</div>
} @else {
<!-- --- ¡ESTA ES LA CORRECCIÓN! --- -->
<!-- Primero verificamos si `summary()` tiene datos, y si los tiene, creamos el alias `data`. -->
@if (summary(); as data) {
<div class="dashboard-grid">
  <!-- ======================== -->
  <!-- MÉTRICAS PRINCIPALES -->
  <!-- ======================== -->
  <div class="stat-card">
    <div class="stat-icon green">
      <span class="material-symbols-outlined">payments</span>
    </div>
    <div class="stat-info">
      <p class="stat-label">Ingresos Totales</p>
      <p class="stat-value">
        {{ data.totalRevenue | currency : "COP" : "symbol" : "1.0-0" }}
      </p>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon blue">
      <span class="material-symbols-outlined">shopping_bag</span>
    </div>
    <div class="stat-info">
      <p class="stat-label">Pedidos Totales</p>
      <p class="stat-value">{{ data.totalOrders }}</p>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon purple">
      <span class="material-symbols-outlined">inventory_2</span>
    </div>
    <div class="stat-info">
      <p class="stat-label">Productos Totales</p>
      <p class="stat-value">{{ data.totalProducts }}</p>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon orange">
      <span class="material-symbols-outlined">sell</span>
    </div>
    <div class="stat-info">
      <p class="stat-label">Valor de Inventario (Venta)</p>
      <p class="stat-value">
        {{ data.inventorySaleValue | currency : "COP" : "symbol" : "1.0-0" }}
      </p>
    </div>
  </div>

  <!-- ======================== -->
  <!-- PEDIDOS POR ESTADO -->
  <!-- ======================== -->
  <div class="card full-width">
    <h2 class="card-title">Pedidos por Estado</h2>
    <div class="status-grid">
      <div class="status-item">
        <p class="status-label">Procesando</p>
        <!-- CORRECCIÓN: Usamos data.orderStatusCounts['Procesando'] -->
        <p class="status-value">
          {{ data.orderStatusCounts["Procesando"] || 0 }}
        </p>
      </div>
      <div class="status-item">
        <p class="status-label">Enviado</p>
        <!-- CORRECCIÓN: Usamos data.orderStatusCounts['Enviado'] -->
        <p class="status-value">{{ data.orderStatusCounts["Enviado"] || 0 }}</p>
      </div>
      <div class="status-item">
        <p class="status-label">Entregado</p>
        <!-- CORRECCIÓN: Usamos data.orderStatusCounts['Entregado'] -->
        <p class="status-value">
          {{ data.orderStatusCounts["Entregado"] || 0 }}
        </p>
      </div>
      <div class="status-item">
        <p class="status-label">Cancelado</p>
        <!-- CORRECCIÓN: Usamos data.orderStatusCounts['Cancelado'] -->
        <p class="status-value">
          {{ data.orderStatusCounts["Cancelado"] || 0 }}
        </p>
      </div>
    </div>
  </div>

  <!-- ======================== -->
  <!-- RENDIMIENTO POR VENDEDOR -->
  <!-- ======================== -->
  <div class="card full-width">
    <h2 class="card-title">Rendimiento por Vendedor</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Vendedor</th>
            <th>Productos</th>
            <th>Valor Inventario (Venta)</th>
            <th>Valor Inventario (Costo)</th>
          </tr>
        </thead>
        <tbody>
          @for (vendor of data.vendorPerformance; track vendor.vendorName) {
          <tr>
            <td>{{ vendor.vendorName }}</td>
            <td>{{ vendor.totalProducts }}</td>
            <td>
              {{
                vendor.inventorySaleValue
                  | currency : "COP" : "symbol" : "1.0-0"
              }}
            </td>
            <td>
              {{
                vendor.inventoryCostValue
                  | currency : "COP" : "symbol" : "1.0-0"
              }}
            </td>
          </tr>
          } @empty {
          <tr>
            <td colspan="4">No hay datos de vendedores.</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- ======================== -->
  <!-- RENDIMIENTO DE CUPONES -->
  <!-- ======================== -->
  <div class="card full-width">
    <h2 class="card-title">Rendimiento de Cupones</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Código de Cupón</th>
            <th>Usos</th>
            <th>Descuento Total</th>
            <th>Ingresos Generados</th>
          </tr>
        </thead>
        <tbody>
          @for (coupon of data.couponPerformance; track coupon._id) {
          <tr>
            <td>
              <strong>{{ coupon._id }}</strong>
            </td>
            <td>{{ coupon.timesUsed }}</td>
            <td>
              {{ coupon.totalDiscount | currency : "COP" : "symbol" : "1.0-0" }}
            </td>
            <td>
              {{
                coupon.totalRevenueGenerated
                  | currency : "COP" : "symbol" : "1.0-0"
              }}
            </td>
          </tr>
          } @empty {
          <tr>
            <td colspan="4">No se han usado cupones en este periodo.</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- ======================== -->
  <!-- PEDIDOS RECIENTES -->
  <!-- ======================== -->
  <div class="card full-width">
    <h2 class="card-title">Pedidos Recientes</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID Pedido</th>
            <th>Cliente</th>
            <th>Monto</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          @for (order of data.recentOrders; track order._id) {
          <tr>
            <td>#{{ order._id.slice(-6).toUpperCase() }}</td>
            <td>{{ order.customerInfo.name }}</td>
            <td>
              {{ order.totalAmount | currency : "COP" : "symbol" : "1.0-0" }}
            </td>
            <td>
              <span class="status-badge" [ngClass]="order.status">{{
                order.status
              }}</span>
            </td>
          </tr>
          } @empty {
          <tr>
            <td colspan="4">No hay pedidos recientes.</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>
} @else {
<!-- Esto se mostrará si no está cargando PERO summary() es nulo o está vacío -->
<div class="empty-state">
  No se encontraron datos para el periodo seleccionado.
</div>
} }
