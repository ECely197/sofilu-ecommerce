<header class="page-header">
  <div class="header-title">
    <a routerLink="/admin/products" class="back-btn" appRipple>
      <span class="material-symbols-outlined">arrow_back</span>
    </a>
    <h1>{{ isEditMode() ? "Editar Producto" : "Nuevo Producto" }}</h1>
  </div>

  <!-- Acciones principales en el header para escritorio -->
  <div class="header-actions desktop-only">
    <a routerLink="/admin/products" class="btn-secondary">Cancelar</a>
    <button
      (click)="handleSubmit()"
      [disabled]="productForm.invalid || isUploading()"
      class="btn-material"
    >
      {{ isUploading() ? "Guardando..." : "Guardar Producto" }}
    </button>
  </div>
</header>

<form [formGroup]="productForm" class="form-container">
  <!-- COLUMNA IZQUIERDA (Principal) -->
  <div class="main-column">
    <!-- Info Básica -->
    <div class="card glass-panel">
      <h2 class="card-title">Información General</h2>

      <div class="material-field">
        <input
          id="name"
          type="text"
          formControlName="name"
          class="material-input"
          placeholder=" "
        />
        <label for="name" class="material-label">Nombre del Producto</label>
      </div>

      <div class="material-field textarea-field">
        <textarea
          id="description"
          formControlName="description"
          class="material-input"
          rows="6"
          placeholder=" "
        ></textarea>
        <label for="description" class="material-label"
          >Descripción Detallada</label
        >
      </div>
    </div>

    <!-- Variantes (Diseño Mejorado) -->
    <div class="card glass-panel" formArrayName="variants">
      <div class="card-header-row">
        <h2 class="card-title">Variantes y Opciones</h2>

        <div class="template-actions">
          <div class="select-wrapper">
            <select
              #templateSelect
              (change)="onTemplateSelected($event); templateSelect.value = ''"
              class="template-select"
            >
              <option value="" disabled selected>Usar Plantilla...</option>
              @for (template of variantTemplates(); track template._id) {
                <option [ngValue]="template">
                  {{ template.templateName }}
                </option>
              }
            </select>
            <span class="material-symbols-outlined chevron">expand_more</span>
          </div>
          <button
            type="button"
            (click)="addVariant()"
            class="btn-secondary small"
          >
            <span class="material-symbols-outlined">add</span> Variante
          </button>
        </div>
      </div>

      <div class="variants-list">
        @for (variant of variants.controls; track variant; let i = $index) {
          <div class="variant-card" [formGroupName]="i">
            <div class="variant-header">
              <div class="material-field">
                <input
                  type="text"
                  formControlName="name"
                  class="material-input"
                  placeholder=" "
                />
                <label class="material-label">Nombre (ej: Talla, Color)</label>
              </div>
              <button
                type="button"
                (click)="removeVariant(i)"
                class="btn-icon delete"
                title="Eliminar Variante"
              >
                <span class="material-symbols-outlined">delete</span>
              </button>
            </div>

            <div class="options-container" formArrayName="options">
              <h4 class="options-title">Opciones</h4>

              <div class="options-grid">
                @for (
                  option of variantOptions(i).controls;
                  track option;
                  let j = $index
                ) {
                  <div class="option-item" [formGroupName]="j">
                    <!-- Fila 1: Valor e Imagen -->
                    <div class="option-main">
                      <div class="material-field compact">
                        <input
                          type="text"
                          formControlName="name"
                          class="material-input"
                          placeholder=" "
                        />
                        <label class="material-label">Valor</label>
                      </div>

                      <!-- Mini Uploader para Opción -->
                      <label class="mini-image-upload">
                        @if (option.get("image")?.value) {
                          <img
                            [src]="option.get('image')?.value"
                            class="preview"
                          />
                        } @else {
                          <span class="material-symbols-outlined"
                            >add_photo_alternate</span
                          >
                        }
                        <input
                          type="file"
                          (change)="onVariantImageSelected($event, i, j)"
                          accept="image/*"
                          hidden
                        />
                      </label>
                    </div>

                    <!-- Fila 2: Precios y Stock -->
                    <div class="option-details">
                      <div class="material-field compact">
                        <input
                          type="text"
                          formControlName="price"
                          class="material-input"
                          placeholder=" "
                          appNumericFormat
                        />
                        <label class="material-label">+ Precio</label>
                      </div>
                      <div class="material-field compact">
                        <input
                          type="text"
                          formControlName="stock"
                          class="material-input"
                          placeholder=" "
                          appNumericFormat
                        />
                        <label class="material-label">Stock</label>
                      </div>
                      <div class="material-field compact">
                        <input
                          type="text"
                          formControlName="costPrice"
                          class="material-input"
                          placeholder=" "
                          appNumericFormat
                        />
                        <label class="material-label">Costo</label>
                      </div>
                    </div>

                    <button
                      type="button"
                      (click)="removeVariantOption(i, j)"
                      class="btn-remove-option"
                    >
                      <span class="material-symbols-outlined">close</span>
                    </button>
                  </div>
                }
              </div>

              <button
                type="button"
                (click)="addVariantOption(i)"
                class="btn-dashed full-width"
              >
                + Añadir Opción
              </button>
            </div>
          </div>
        } @empty {
          <div class="empty-variants">
            <p>Este producto no tiene variantes (es un producto simple).</p>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- COLUMNA DERECHA (Lateral) -->
  <div class="sidebar-column">
    <!-- Imágenes -->
    <div class="card glass-panel">
      <h2 class="card-title">Galería</h2>
      <div class="gallery-uploader">
        <!-- Grid de previsualización -->
        @if (imagePreviews().length > 0) {
          <div class="preview-grid">
            @for (preview of imagePreviews(); track preview) {
              <div class="preview-item">
                <img [src]="preview" alt="Preview" />
                <!-- Aquí podrías añadir botón para quitar imagen individual -->
              </div>
            }
          </div>
        }

        <label
          class="upload-zone"
          [class.has-images]="imagePreviews().length > 0"
        >
          <span class="material-symbols-outlined icon">cloud_upload</span>
          <span class="text">Click para subir imágenes</span>
          <span class="subtext">Soporta múltiples archivos</span>
          <input
            type="file"
            (change)="onFilesSelected($event)"
            accept="image/*"
            multiple
            hidden
          />
        </label>
      </div>
    </div>

    <!-- Precio y Stock (Global) -->
    <div class="card glass-panel">
      <h2 class="card-title">Inventario Base</h2>
      <div class="form-row">
        <div class="material-field">
          <input
            id="price"
            type="text"
            formControlName="price"
            class="material-input"
            placeholder=" "
            appNumericFormat
          />
          <label for="price" class="material-label">Precio Venta</label>
        </div>
        <div class="material-field">
          <input
            id="stock"
            type="text"
            formControlName="stock"
            class="material-input"
            placeholder=" "
            appNumericFormat
          />
          <label for="stock" class="material-label">Stock Total</label>
        </div>
      </div>
      <div class="material-field">
        <input
          id="costPrice"
          type="text"
          formControlName="costPrice"
          class="material-input"
          placeholder=" "
          appNumericFormat
        />
        <label for="costPrice" class="material-label">Costo Unitario</label>
      </div>

      <!-- Oferta -->
      <div class="toggle-row">
        <div class="checkbox-wrapper">
          <input
            id="isOnSale"
            type="checkbox"
            formControlName="isOnSale"
            class="custom-checkbox"
          />
          <label for="isOnSale">¿En Oferta?</label>
        </div>
      </div>

      @if (productForm.get("isOnSale")?.value) {
        <div class="material-field fade-in">
          <input
            id="salePrice"
            type="text"
            formControlName="salePrice"
            class="material-input"
            placeholder=" "
            appNumericFormat
          />
          <label for="salePrice" class="material-label">Precio Oferta</label>
        </div>
      }
    </div>

    <!-- Organización -->
    <div class="card glass-panel">
      <h2 class="card-title">Organización</h2>
      <div class="material-field">
        <input
          id="sku"
          type="text"
          formControlName="sku"
          class="material-input"
          placeholder=" "
        />
        <label for="sku" class="material-label">SKU</label>
      </div>

      <div class="custom-multiselect">
        <label class="field-label">Categorías</label>

        <!-- Área de Selección (Trigger) -->
        <div
          class="select-trigger"
          (click)="isCategoryDropdownOpen.set(!isCategoryDropdownOpen())"
          [class.active]="isCategoryDropdownOpen()"
        >
          <div class="chips-container">
            @if (productForm.get("categories")?.value?.length > 0) {
              @for (
                catId of productForm.get("categories")?.value;
                track catId
              ) {
                <span class="category-chip" (click)="$event.stopPropagation()">
                  {{ getCategoryName(catId) }}
                  <span class="remove" (click)="toggleCategory(catId)">×</span>
                </span>
              }
            } @else {
              <span class="placeholder">Seleccionar categorías...</span>
            }
          </div>
          <span class="material-symbols-outlined chevron">expand_more</span>
        </div>

        <!-- Lista Desplegable -->
        @if (isCategoryDropdownOpen()) {
          <div class="dropdown-list custom-scroll">
            @for (cat of categories(); track cat._id) {
              <div
                class="dropdown-item"
                [class.selected]="isCategorySelected(cat._id)"
                (click)="toggleCategory(cat._id)"
              >
                <div class="checkbox">
                  @if (isCategorySelected(cat._id)) {
                    <span class="material-symbols-outlined check">check</span>
                  }
                </div>
                <span>{{ cat.name }}</span>
              </div>
            }
          </div>
          <!-- Overlay transparente para cerrar al hacer clic afuera -->
          <div
            class="click-overlay"
            (click)="isCategoryDropdownOpen.set(false)"
          ></div>
        }
      </div>

      <div class="select-field">
        <label>Vendedor</label>
        <div class="select-wrapper">
          <select formControlName="vendor">
            <option [ngValue]="null">Ninguno</option>
            @for (vend of vendors(); track vend._id) {
              <option [value]="vend._id">{{ vend.name }}</option>
            }
          </select>
          <span class="material-symbols-outlined chevron">expand_more</span>
        </div>
      </div>

      <div class="select-field">
        <label>Garantía</label>
        <div class="select-wrapper">
          <select formControlName="warrantyType">
            <option [ngValue]="null">Sin Garantía</option>
            @for (war of warranties(); track war._id) {
              <option [value]="war._id">
                {{ war.name }} ({{ war.durationMonths }} Meses)
              </option>
            }
          </select>
          <span class="material-symbols-outlined chevron">expand_more</span>
        </div>
      </div>

      <div class="checkbox-wrapper mt-2">
        <input
          id="isFeatured"
          type="checkbox"
          formControlName="isFeatured"
          class="custom-checkbox"
        />
        <label for="isFeatured">Producto Destacado</label>
      </div>
    </div>
  </div>
</form>

<!-- BARRA FLOTANTE MÓVIL (STICKY) -->
<div class="sticky-footer-actions mobile-only">
  <button type="button" routerLink="/admin/products" class="btn-secondary">
    Cancelar
  </button>
  <button
    type="button"
    (click)="handleSubmit()"
    [disabled]="productForm.invalid || isUploading()"
    class="btn-material"
  >
    {{ isUploading() ? "..." : "Guardar" }}
  </button>
</div>
