<!-- En: src/app/pages/admin/product-form/product-form.html -->
<header class="page-header">
  <h1>{{ isEditMode() ? "Editar Producto" : "Crear Nuevo Producto" }}</h1>
</header>

<form
  [formGroup]="productForm"
  (ngSubmit)="handleSubmit()"
  class="form-container"
>
  <!-- Columna Principal (Izquierda) -->
  <div class="main-column">
    <div class="card">
      <h2 class="card-title">Información Principal</h2>
      <!-- ... (campos de nombre y descripción sin cambios) ... -->
      <div class="form-field">
        <label for="name">Nombre del producto</label>
        <input
          id="name"
          type="text"
          formControlName="name"
          class="form-input"
        />
      </div>
      <div class="form-field">
        <label for="description">Descripción</label>
        <textarea
          id="description"
          formControlName="description"
          rows="6"
          class="form-input"
        ></textarea>
      </div>
    </div>

    <div class="card" formArrayName="variants">
      <!-- ... (código de variantes sin cambios) ... -->
      <div class="card-header">
        <h2 class="card-title">Variantes</h2>
        <button
          type="button"
          (click)="addVariant()"
          class="add-button-small"
          appRipple
        >
          + Añadir Variante
        </button>
      </div>

      @for (variant of variants.controls; track variant; let i = $index) {
      <div class="variant-group" [formGroupName]="i">
        <div class="variant-header">
          <input
            type="text"
            formControlName="name"
            placeholder="Nombre de la variante (ej. Talla)"
            class="form-input"
          />
          <button
            type="button"
            (click)="removeVariant(i)"
            class="delete-button-small"
          >
            ✖
          </button>
        </div>

        <div class="options-group" formArrayName="options">
          <label class="options-label">Opciones</label>
          <div class="options-list">
            <!-- Cabecera de la tabla de opciones -->
            <div class="option-item header">
              <label class="flex-3">Valor (ej. S, M, L)</label>
              <label class="flex-2">Modificador de Precio (+)</label>
              <label class="flex-2">Stock</label>
              <label class="flex-2">Costo</label>
              <div class="flex-1"></div>
            </div>

            <!-- Iteramos sobre las opciones -->
            @for (option of variantOptions(i).controls; track option; let j =
            $index) {
            <div class="option-item" [formGroupName]="j">
              <input
                type="text"
                formControlName="name"
                placeholder="Valor"
                class="form-input-small flex-3"
              />
              <input
                type="number"
                formControlName="priceModifier"
                placeholder="+ COP"
                class="form-input-small flex-2"
              />
              <input
                type="number"
                formControlName="costPrice"
                placeholder="Costo"
                class="form-input-small flex-2"
              />
              <input
                type="number"
                formControlName="stock"
                placeholder="Cantidad"
                class="form-input-small flex-2"
              />
              <button
                type="button"
                (click)="removeVariantOption(i, j)"
                class="delete-button-tiny flex-1"
              >
                ✖
              </button>
            </div>
            }
          </div>
          <button
            type="button"
            (click)="addVariantOption(i)"
            class="add-button-tiny"
            appRipple
          >
            + Añadir opción
          </button>
        </div>
      </div>
      }
    </div>
  </div>

  <!-- Columna Lateral (Derecha) -->
  <div class="sidebar-column">
    <!-- TARJETA DE IMÁGENES POR URL -->
    <div class="card">
      <h2 class="card-title">Imágenes del Producto</h2>
      <div class="image-upload-area">
        <div class="image-preview-grid">
          @for(preview of imagePreviews(); track preview) {
          <img [src]="preview" alt="Vista previa" class="image-preview" />
          }
        </div>
        <label for="image-upload" class="upload-button" appRipple
          >Seleccionar Imágenes</label
        >
        <input
          id="image-upload"
          type="file"
          (change)="onFilesSelected($event)"
          accept="image/*"
          multiple
        />
        <small class="field-description"
          >Puedes seleccionar varias imágenes a la vez.</small
        >
      </div>
    </div>

    <!-- ... (tarjetas de Organización y Precio sin cambios) ... -->
    <div class="card">
      <h2 class="card-title">Organización</h2>
      <div class="form-field has-arrow">
        <label for="category">Categoría</label>
        <select
          id="category"
          formControlName="category"
          class="form-input"
          as="select"
        >
          <option [ngValue]="null" disabled>Selecciona una categoría</option>
          @for (cat of categories(); track cat._id) {
          <option [value]="cat._id">{{ cat.name }}</option>
          }
        </select>
      </div>
      <div class="checkbox-field">
        <input id="isFeatured" type="checkbox" formControlName="isFeatured" />
        <label for="isFeatured">Producto Destacado</label>
      </div>
      <div class="checkbox-field">
        <input id="isOnSale" type="checkbox" formControlName="isOnSale" />
        <label for="isOnSale">Producto en Oferta</label>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">Precio y Costo</h2>
      <div class="form-field">
        <label for="price">Precio de Venta (Cliente)</label>
        <input
          id="price"
          type="number"
          formControlName="price"
          class="form-input"
        />
      </div>
      @if (productForm.get('isOnSale')?.value) {
      <div class="form-field">
        <label for="salePrice">Precio de Oferta</label>
        <input
          id="salePrice"
          type="number"
          formControlName="salePrice"
          class="form-input"
        />
      </div>
      <div class="form-field">
        <label for="costPrice">Costo del Producto (Interno)</label>
        <input
          id="costPrice"
          type="number"
          formControlName="costPrice"
          class="form-input"
        />
      </div>
      }
    </div>
  </div>

  <!-- Acciones del Formulario -->
  <div class="form-actions">
    <a routerLink="/admin/products" class="btn-secondary" appRipple>Cancelar</a>
    <button
      type="submit"
      [disabled]="productForm.invalid || isUploading()"
      class="btn-material"
      appRipple
    >
      {{
        isUploading()
          ? "Subiendo imágenes..."
          : isEditMode()
          ? "Guardar Cambios"
          : "Guardar Producto"
      }}
    </button>
  </div>
</form>
