<header class="page-header">
  <h1>{{ isEditMode() ? "Editar Producto" : "Crear Nuevo Producto" }}</h1>
</header>

<form
  [formGroup]="productForm"
  (ngSubmit)="handleSubmit()"
  class="form-container"
>
  <!-- ======================== -->
  <!-- Columna Principal -->
  <!-- ======================== -->
  <div class="main-column">
    <div class="card">
      <h2 class="card-title">Información Principal</h2>

      <div class="material-field">
        <input
          id="name"
          type="text"
          formControlName="name"
          class="material-input"
          placeholder=" "
        />
        <label for="name" class="material-label">Nombre del producto</label>
      </div>

      <div class="material-field textarea-field">
        <textarea
          id="description"
          formControlName="description"
          class="material-input"
          rows="6"
          placeholder=" "
        >
        </textarea>
        <label for="description" class="material-label">Descripción</label>
      </div>
    </div>

    <div class="card" formArrayName="variants">
      <div class="card-header">
        <h2 class="card-title">Variantes</h2>

        <div class="template-selector form-field has-arrow">
          <select
            #templateSelect
            (change)="onTemplateSelected($event); templateSelect.value = ''"
            class="form-input"
          >
            <option value="" disabled selected>
              Añadir desde plantilla...
            </option>
            @for (template of variantTemplates(); track template._id) {
            <option [ngValue]="template">{{ template.templateName }}</option>
            }
          </select>
        </div>

        <button type="button" (click)="addVariant()" class="add-button-small">
          + Añadir Variante Manualmente
        </button>
      </div>

      @for (variant of variants.controls; track variant; let i = $index) {
      <div class="variant-group" [formGroupName]="i">
        <div class="variant-header">
          <input
            type="text"
            formControlName="name"
            placeholder="Nombre de la variante (ej. Talla)"
            class="form-input"
          />
          <button
            type="button"
            (click)="removeVariant(i)"
            class="delete-button-small"
          >
            ✖
          </button>
        </div>

        <div class="options-group" formArrayName="options">
          <div class="options-table-wrapper">
            <div class="options-list">
              <!-- Cabecera y filas ahora son hijos directos del grid -->

              <!-- Cabecera de la tabla -->
              <label class="grid-header">Valor (ej. S, M, L)</label>
              <label class="grid-header">Modificador de Precio (+)</label>
              <label class="grid-header">Stock</label>
              <label class="grid-header">Costo</label>
              <div class="grid-header"></div>
              <!-- Celda vacía para el botón de eliminar -->

              <!-- Iteramos sobre las opciones -->
              @for (option of variantOptions(i).controls; track option; let j =
              $index) {
              <div class="option-row" [formGroupName]="j">
                <input
                  type="text"
                  formControlName="name"
                  placeholder="Valor"
                  class="form-input-small"
                />
                <input
                  type="text"
                  formControlName="priceModifier"
                  placeholder="+ COP"
                  class="form-input-small"
                  appNumericFormat
                />
                <input
                  type="text"
                  formControlName="stock"
                  placeholder="Cantidad"
                  class="form-input-small"
                  appNumericFormat
                />
                <input
                  type="text"
                  formControlName="costPrice"
                  placeholder="Costo"
                  class="form-input-small"
                  appNumericFormat
                />
                <button
                  type="button"
                  (click)="removeVariantOption(i, j)"
                  class="delete-button-tiny"
                >
                  ✖
                </button>
              </div>
              }
            </div>
          </div>
          <button
            type="button"
            (click)="addVariantOption(i)"
            class="add-button-tiny"
            appRipple
          >
            + Añadir opción
          </button>
        </div>
      </div>
      }
    </div>
  </div>

  <!-- ======================== -->
  <!-- Columna Lateral -->
  <!-- ======================== -->
  <div class="sidebar-column">
    <div class="card">
      <h2 class="card-title">Imágenes del Producto</h2>
      <div class="image-upload-area">
        <div class="image-preview-grid">
          @for(preview of imagePreviews(); track preview) {
          <img [src]="preview" alt="Vista previa" class="image-preview" />
          }
        </div>
        <label
          for="image-upload"
          class="upload-button btn btn-secondary"
          appRipple
        >
          {{
            imagePreviews().length > 0
              ? "Cambiar Imágenes"
              : "Seleccionar Imágenes"
          }}
        </label>
        <input
          id="image-upload"
          type="file"
          (change)="onFilesSelected($event)"
          accept="image/*"
          multiple
          class="file-input"
        />
        <small class="field-description"
          >Puedes seleccionar varias imágenes a la vez.</small
        >
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">Organización</h2>
      <div class="form-field has-arrow">
        <label for="category">Categoría</label>
        <select id="category" formControlName="category" class="form-input">
          <option [ngValue]="null" disabled>Selecciona una categoría</option>
          @for (cat of categories(); track cat._id) {
          <option [value]="cat._id">{{ cat.name }}</option>
          }
        </select>
      </div>
      <div class="checkbox-field">
        <input id="isFeatured" type="checkbox" formControlName="isFeatured" />
        <label for="isFeatured">Producto Destacado</label>
      </div>
      <div class="checkbox-field">
        <input id="isOnSale" type="checkbox" formControlName="isOnSale" />
        <label for="isOnSale">Producto en Oferta</label>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">Precio y Costo</h2>
      <div class="form-grid">
        <div class="material-field">
          <input
            id="price"
            type="text"
            formControlName="price"
            class="material-input"
            placeholder=" "
            appNumericFormat
          />
          <label for="price" class="material-label">Precio de Venta</label>
        </div>
        <div class="material-field">
          <input
            id="costPrice"
            type="text"
            formControlName="costPrice"
            class="material-input"
            placeholder=" "
            appNumericFormat
          />
          <label for="costPrice" class="material-label">Costo (Interno)</label>
        </div>
      </div>
      @if (productForm.get('isOnSale')?.value) {
      <div class="material-field">
        <input
          id="salePrice"
          type="text"
          formControlName="salePrice"
          class="material-input"
          placeholder=" "
          appNumericFormat
        />
        <label for="salePrice" class="material-label">Precio de Oferta</label>
      </div>
      }
    </div>
  </div>

  <!-- ======================== -->
  <!-- Acciones del Formulario -->
  <!-- ======================== -->
  <div class="form-actions">
    <a routerLink="/admin/products" class="btn btn-secondary" appRipple
      >Cancelar</a
    >
    <button
      type="submit"
      [disabled]="productForm.invalid || isUploading()"
      class="btn btn-primary"
      appRipple
    >
      {{
        isUploading()
          ? "Guardando..."
          : isEditMode()
          ? "Guardar Cambios"
          : "Guardar Producto"
      }}
    </button>
  </div>
</form>
