<!-- ==========================================================================
   PÁGINA DE DETALLE DE PRODUCTO (VERSIÓN FINAL CON GALERÍA RESPONSIVE)
   ========================================================================== -->

@if (product(); as currentProduct) {
<div class="page-container">
  <!-- LAYOUT PRINCIPAL: GALERÍA E INFORMACIÓN -->
  <div class="product-detail-layout">
    <!-- ======================== -->
    <!-- COLUMNA 1: GALERÍA -->
    <!-- ======================== -->
    <div class="gallery-card card" data-aos="fade-right">
      <div class="desktop-gallery">
        <!-- ¡CAMBIO! La lista de miniaturas ahora itera sobre `galleryImages()` -->
        @if (galleryImages().length > 1) {
        <div class="thumbnail-wrapper">
          @for (image of galleryImages(); track image) {
          <div
            class="thumbnail"
            [class.active]="selectedImage() === image"
            (click)="selectedImage.set(image)"
          >
            <img
              [src]="image"
              [alt]="'Thumbnail ' + currentProduct.name"
              loading="lazy"
              decoding="async"
            />
          </div>
          }
        </div>
        }
        <!-- La imagen principal no necesita cambios, ya que `selectedImage` se actualiza solo -->
        <div class="main-image-wrapper">
          @if (currentProduct.images && currentProduct.images.length > 0) {
          <img
            [src]="selectedImage()"
            [alt]="currentProduct.name"
            class="main-image"
          />
          } @else {
          <div class="main-image placeholder-image"></div>
          }
        </div>
      </div>

      <!-- Galería móvil también debe usar `galleryImages()` -->
      @if (galleryImages().length > 0) {
      <div class="mobile-swiper">
        <div class="swiper-wrapper">
          @for(image of galleryImages(); track image) {
          <div class="swiper-slide">
            <img
              [src]="image"
              [alt]="currentProduct.name"
              class="main-image-mobile"
              loading="lazy"
              decoding="async"
            />
          </div>
          }
        </div>
        <div class="swiper-pagination"></div>
      </div>
      }
    </div>

    <!-- ======================== -->
    <!-- COLUMNA 2: INFORMACIÓN Y ACCIONES -->
    <!-- ======================== -->
    <div class="info-card card" data-aos="fade-left" data-aos-delay="100">
      <h1 class="product-title">{{ currentProduct.name }}</h1>
      <p class="product-price">
        {{ finalPrice() | currency : "COP" : "symbol" : "1.0-0" }}
        @if(currentProduct.variants.length > 0 && !allVariantsSelected()) {
        <span class="price-suffix">Desde</span>
        }
      </p>

      <div class="variants-scroll-container">
        <div class="variants-container accordion">
          @for (variant of currentProduct.variants; track variant.name) {
          <div class="variant-group accordion-item">
            <!-- CABECERA DEL ACORDEÓN (Siempre visible) -->
            <div class="accordion-header" (click)="toggleVariant(variant.name)">
              <!-- Vista previa de la imagen de la variante -->
              @if (variantPreviewImages()[variant.name]) {
              <img
                [src]="variantPreviewImages()[variant.name]"
                alt="{{ variant.name }}"
                class="accordion-preview-image"
              />
              } @else {
              <div class="accordion-preview-placeholder"></div>
              }

              <!-- Nombre y selección actual -->
              <div class="accordion-info">
                <span class="variant-name">{{ variant.name }}</span>
                <span class="variant-selection">{{
                  selectedVariants()[variant.name] || ""
                }}</span>
              </div>

              <!-- Icono de despliegue -->
              <span
                class="material-symbols-outlined accordion-icon"
                [class.expanded]="expandedVariant() === variant.name"
                >expand_more</span
              >
            </div>

            <!-- CONTENIDO DEL ACORDEÓN (Desplegable) -->
            <div
              class="accordion-content"
              [@expandCollapse]="
                expandedVariant() === variant.name ? 'expanded' : 'collapsed'
              "
            >
              <div class="variant-options-grid">
                @for (option of variant.options; track option.name) {
                <div
                  class="option-card"
                  [class.active]="isSelected(variant.name, option.name)"
                  [class.unavailable]="!isOptionAvailable(option)"
                  (click)="
                    !isOptionAvailable(option)
                      ? null
                      : selectOption(variant.name, option.name)
                  "
                >
                  @if (option.image) {
                  <img
                    [src]="option.image"
                    alt="{{ option.name }}"
                    class="option-image"
                  />
                  } @else {
                  <div class="option-image-placeholder"></div>
                  }
                  <div class="option-details">
                    <span class="option-name">{{ option.name }}</span>
                    @if (option.price > 0) {
                    <span class="option-price"
                      >+{{
                        option.price | currency : "COP" : "symbol" : "1.0-0"
                      }}</span
                    >
                    }
                  </div>
                </div>
                }
              </div>
            </div>
          </div>
          }
        </div>
      </div>

      <div class="actions">
        <div class="quantity-selector">
          <button (click)="decreaseQuantity()" class="quantity-btn" appRipple>
            -
          </button>
          <span class="quantity-value">{{ quantity() }}</span>
          <button (click)="increaseQuantity()" class="quantity-btn" appRipple>
            +
          </button>
        </div>
        <button
          class="btn btn-primary add-to-cart-btn"
          [disabled]="
            !allVariantsSelected() || !isInStock() || justAddedToCart()
          "
          (click)="addToCart()"
          appRipple
        >
          @if(justAddedToCart()){
          <span class="material-symbols-outlined">check</span>
          <span>Añadido</span>
          } @else {
          <span>{{
            canAddToCart() ? "Añadir al carrito" : "No disponible"
          }}</span>
          }
        </button>
        <button
          class="btn btn-secondary wishlist-btn"
          (click)="toggleWishlist()"
          appRipple
        >
          <span class="material-symbols-outlined">{{
            isProductInWishlist() ? "favorite" : "favorite_border"
          }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ======================== -->
  <!-- SECCIÓN DE DETALLES ADICIONALES -->
  <!-- ======================== -->
  <div class="details-card card" data-aos="fade-up">
    <div class="tab-header">
      <button
        class="tab-link"
        [class.active]="activeTab() === 'description'"
        (click)="activeTab.set('description')"
      >
        Descripción
      </button>
      <button
        class="tab-link"
        [class.active]="activeTab() === 'reviews'"
        (click)="activeTab.set('reviews')"
      >
        Opiniones ({{ reviews().length }})
      </button>
    </div>
    <div class="tab-content">
      @if (activeTab() === 'description') {
      <div
        class="prose"
        [innerHTML]="currentProduct.description | safeHtml"
      ></div>
      } @if (activeTab() === 'reviews') {
      <div class="reviews-section">
        <div class="reviews-summary">
          <h3 class="reviews-summary-title">Opiniones de nuestros clientes</h3>
          @if(canWriteReview()){
          <button class="btn btn-secondary" (click)="scrollToReviewForm()">
            Escribir una reseña
          </button>
          }
        </div>
        <div class="reviews-list">
          @for (review of reviews(); track review._id) {
          <div class="review-card">
            <div class="review-header">
              <span class="review-author">{{ review.author }}</span>
              <span class="review-date">{{
                review.createdAt | date : "longDate"
              }}</span>
            </div>
            <div class="review-rating">
              <app-star-rating
                [rating]="review.rating"
                [readonly]="true"
              ></app-star-rating>
            </div>
            <h4 class="review-title">{{ review.title }}</h4>
            <p class="review-comment">{{ review.comment }}</p>
          </div>
          } @empty {
          <p class="empty-reviews-message">
            Este producto aún no tiene reseñas. ¡Sé el primero!
          </p>
          }
        </div>
        @if (canWriteReview()) {
        <div class="review-form-container" #reviewFormElement>
          <h3 class="review-form-title">Comparte tu opinión</h3>
          <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
            <div class="form-field rating-field">
              <label>Calificación</label>
              <app-star-rating formControlName="rating"></app-star-rating>
            </div>
            <div class="material-field">
              <input
                id="title"
                type="text"
                formControlName="title"
                placeholder=" "
                class="material-input"
              />
              <label for="title" class="material-label"
                >Título de tu reseña</label
              >
            </div>
            <div class="material-field textarea-field">
              <textarea
                id="comment"
                formControlName="comment"
                placeholder=" "
                rows="4"
                class="material-input"
              ></textarea>
              <label for="comment" class="material-label"
                >Cuéntanos más sobre tu experiencia...</label
              >
            </div>
            <button
              type="submit"
              [disabled]="reviewForm.invalid"
              class="btn btn-primary submit-review-btn"
            >
              Enviar mi reseña
            </button>
          </form>
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>
} @else {
<div class="loading-container">
  <p>Cargando detalles del producto...</p>
</div>
}
