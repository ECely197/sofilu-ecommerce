@if (product()) {
<div
  class="product-detail-layout"
  data-aos="fade-right"
  data-aos-duration="600"
>
  <!-- ======================================= -->
  <!-- COLUMNA IZQUIERDA: GALERÍA DE IMÁGENES -->
  <!-- ======================================= -->
  <div class="image-gallery" data-aos="fade-right">
    <!-- Imagen Principal (reacciona a la selección) -->
    @if (product()!.images.length > 0) {
    <div
      class="main-image"
      data-aos="fade-left"
      data-aos-delay="100"
      [style.backgroundImage]="'url(' + selectedImage() + ')'"
    ></div>
    } @else {
    <div class="main-image placeholder-image"></div>
    }

    <!-- Miniaturas (se muestran si hay más de una imagen) -->
    @if (product()!.images.length > 1) {
    <div class="thumbnail-grid">
      @for (image of product()!.images; track image) {
      <div
        class="thumbnail"
        [style.backgroundImage]="'url(' + image + ')'"
        (click)="selectedImage.set(image)"
        [class.active]="selectedImage() === image"
      ></div>
      }
    </div>
    }
  </div>

  <!-- ========================================== -->
  <!-- COLUMNA DERECHA: INFORMACIÓN Y ACCIONES -->
  <!-- ========================================== -->
  <div class="product-info" data-aos="fade-left" data-aos-delay="100">
    <h1 class="product-title">{{ product()!.name }}</h1>
    <p class="product-price">
      {{ finalPrice() | currency : "COP" : "symbol" : "1.0-0" }}
    </p>

    <!-- SECCIÓN DE VARIANTES -->
    @for (variant of product()!.variants; track variant.name) {
    <div class="variant-group">
      <p class="variant-name">{{ variant.name }}</p>
      <div class="variant-options">
        @for (option of variant.options; track option.name) {
        <button
          class="variant-button"
          [class.active]="isSelected(variant.name, option.name)"
          [class.unavailable]="!isOptionAvailable(option)"
          [disabled]="!isOptionAvailable(option)"
          (click)="selectOption(variant.name, option.name)"
        >
          {{ option.name }}
        </button>
        }
      </div>
    </div>
    }

    <!-- ACCIONES PRINCIPALES -->
    <div class="actions">
      <button
        class="btn-material"
        [disabled]="!isInStock()"
        (click)="addToCart()"
        appRipple
      >
        {{ isInStock() ? "Añadir al carrito" : "Agotado" }}
      </button>
      <button class="btn-secondary" appRipple (click)="toggleWishlist()">
        <!-- Usamos un icono de Material Symbols para el corazón -->
        <span class="material-symbols-outlined">
          {{ isProductInWishlist() ? "favorite" : "favorite_border" }}
        </span>
        {{ isProductInWishlist() ? "En tu lista" : "Añadir a la lista" }}
      </button>
    </div>
  </div>
</div>

<!-- ======================================= -->
<!-- SECCIÓN DE PESTAÑAS (TABS) ABAJO      -->
<!-- ======================================= -->
<div class="product-tabs-container" data-aos="fade-up" data-aos-offset="100">
  <div class="tab-header">
    <button
      class="tab-link"
      [class.active]="activeTab() === 'description'"
      (click)="activeTab.set('description')"
    >
      Descripción
    </button>
    <button
      class="tab-link"
      [class.active]="activeTab() === 'reviews'"
      (click)="activeTab.set('reviews')"
    >
      Opiniones ({{ reviews().length }})
    </button>
  </div>

  <div class="tab-content">
    <!-- Contenido Pestaña Descripción -->
    @if (activeTab() === 'description') {
    <div class="prose" [innerHTML]="product()!.description"></div>
    }

    <!-- Contenido Pestaña Reseñas -->
    @if (activeTab() === 'reviews') {
    <div class="reviews-section">
      <div class="reviews-summary">
        <div>
          <h3 class="reviews-summary-title">Opiniones de nuestros clientes</h3>
        </div>
        @if(canWriteReview()){
        <button class="btn-secondary" (click)="scrollToReviewForm()">
          Escribir una reseña
        </button>
        }
      </div>

      <div class="reviews-list">
        @for (review of reviews(); track review._id) {
        <div class="review-card">
          <div class="review-header">
            <span class="review-author">{{ review.author }}</span>
            <span class="review-date">{{
              review.createdAt | date : "longDate"
            }}</span>
          </div>
          <div class="review-rating">
            @for (star of [].constructor(review.rating); track $index) {
            <span class="star filled">★</span>
            } @for (star of [].constructor(5 - review.rating); track $index) {
            <span class="star">★</span>
            }
          </div>
          <h3 class="review-title">{{ review.title }}</h3>
          <p class="review-comment">{{ review.comment }}</p>
        </div>
        } @empty {
        <p class="empty-reviews-message">
          Este producto aún no tiene reseñas. ¡Sé el primero en compartir tu
          opinión!
        </p>
        }
      </div>

      @if (canWriteReview()) {
      <div class="review-form-container" #reviewFormElement>
        <h3 class="review-form-title">Comparte tu opinión</h3>
        <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
          <div class="form-field">
            <label for="rating">Calificación</label>
            <select id="rating" formControlName="rating" class="form-input">
              <option [ngValue]="null" disabled>
                Selecciona una calificación
              </option>
              <option [value]="5">5 Estrellas - Excelente</option>
              <option [value]="4">4 Estrellas - Bueno</option>
              <option [value]="3">3 Estrellas - Regular</option>
              <option [value]="2">2 Estrellas - Malo</option>
              <option [value]="1">1 Estrella - Pésimo</option>
            </select>
          </div>
          <div class="form-field">
            <label for="title">Título de tu reseña</label>
            <input
              id="title"
              type="text"
              formControlName="title"
              placeholder="Ej: ¡Me encantó!"
              class="form-input"
            />
          </div>
          <div class="form-field">
            <label for="comment">Tu reseña</label>
            <textarea
              id="comment"
              formControlName="comment"
              placeholder="Cuéntanos más sobre tu experiencia..."
              rows="4"
              class="form-input"
            ></textarea>
          </div>
          <button
            type="submit"
            [disabled]="reviewForm.invalid"
            class="btn-material"
          >
            Enviar mi reseña
          </button>
        </form>
      </div>
      }
    </div>
    }
  </div>
</div>
} @else {
<div class="loading-container">
  <p>Cargando detalles del producto...</p>
  <!-- Aquí podrías poner un spinner animado -->
</div>
}
