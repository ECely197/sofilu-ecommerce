<section class="orders-section">
  <h2 class="section-title">Historial de Pedidos</h2>

  <div *ngIf="isLoadingOrders" class="loading-state">
    Cargando tus pedidos...
  </div>

  <div class="orders-list">
    @for (order of orders; track order._id) {
    <div
      class="order-card"
      [class.is-expanded]="expandedOrderId() === order._id"
    >
      <!-- CABECERA DEL PEDIDO (Clickable) -->
      <div class="order-card-header" (click)="toggleOrderDetails(order._id)">
        <div class="header-info">
          <p class="order-id">
            Pedido #{{ order._id.slice(-6).toUpperCase() }}
          </p>
          <p class="order-date">{{ order.createdAt | date : "longDate" }}</p>
        </div>
        <div class="header-summary">
          <span class="order-total">{{
            order.totalAmount | currency : "COP" : "symbol" : "1.0-0"
          }}</span>
          <span class="status-chip" [ngClass]="order.status.toLowerCase()">{{
            order.status
          }}</span>
          <span class="material-symbols-outlined expand-icon">expand_more</span>
        </div>
      </div>

      <!-- CONTENIDO EXPANDIBLE (Animado) -->
      <div
        class="order-card-content"
        [@expandCollapse]="
          expandedOrderId() === order._id ? 'expanded' : 'collapsed'
        "
      >
        <div class="content-inner">
          <p class="content-title">Artículos en este pedido:</p>
          <div class="order-items">
            @for (item of order.items; track item._id) {
            <div class="order-item">
              @if (item.product?.images?.length > 0) {
              <img
                [src]="item.product.images[0]"
                [alt]="item.product.name"
                class="item-image"
              />
              } @else {
              <div class="item-image placeholder"></div>
              }
              <div class="item-details">
                <p class="item-name">
                  {{ item.product?.name || "Producto no disponible" }} (x{{
                    item.quantity
                  }})
                </p>
                <div class="item-variants">
                  @for (variantKey of objectKeys(item.selectedVariants); track
                  variantKey) {
                  <span
                    >{{ variantKey }}:
                    <strong>{{
                      item.selectedVariants[variantKey]
                    }}</strong></span
                  >
                  }
                </div>
              </div>
              <p class="item-price">
                {{
                  item.price * item.quantity
                    | currency : "COP" : "symbol" : "1.0-0"
                }}
              </p>
            </div>
            }
          </div>
        </div>
      </div>
    </div>
    }
  </div>

  <div *ngIf="!isLoadingOrders && orders.length === 0" class="empty-state">
    <h3>Aún no has realizado ningún pedido.</h3>
    <a routerLink="/products" class="explore-button" appRipple
      >Empezar a comprar</a
    >
  </div>
</section>
