<section class="orders-section">
  <h2 class="section-title">Historial de Pedidos</h2>

  <!-- Estado de Carga -->
  @if (isLoadingOrders) {
  <div class="loading-state">
    <!-- Puedes añadir un esqueleto de carga aquí si lo deseas -->
    Cargando tus pedidos...
  </div>
  }

  <!-- Lista de Pedidos -->
  @else if (orders.length > 0) {
  <div class="orders-list">
    @for (order of orders; track order._id) {
    <div
      class="order-card"
      [class.is-expanded]="expandedOrderId() === order._id"
    >
      <!-- Cabecera de la Tarjeta de Pedido (Clickable para expandir) -->
      <div class="order-card-header" (click)="toggleOrderDetails(order._id)">
        <div class="header-info">
          <p class="order-id">
            Pedido #{{ order._id.slice(-6).toUpperCase() }}
          </p>
          <p class="order-date">{{ order.createdAt | date : "longDate" }}</p>
        </div>
        <div class="header-summary">
          <span class="order-total">{{
            order.totalAmount | currency : "COP" : "symbol" : "1.0-0"
          }}</span>
          <span class="status-chip" [ngClass]="order.status.toLowerCase()">{{
            order.status
          }}</span>
          <span class="material-symbols-outlined expand-icon">expand_more</span>
        </div>
      </div>

      <!-- Contenido Expandible con los Detalles del Pedido -->
      <div
        class="order-card-content"
        [@expandCollapse]="
          expandedOrderId() === order._id ? 'expanded' : 'collapsed'
        "
      >
        <div class="content-inner">
          <p class="content-title">Artículos en este pedido:</p>
          <div class="order-items">
            @for (item of order.items; track item._id) {
            <div class="order-item">
              @if (item.product?.images?.length > 0) {
              <img
                [src]="item.product.images[0]"
                [alt]="item.product.name"
                class="item-image"
              />
              } @else {
              <div class="item-image placeholder"></div>
              }
              <div class="item-details">
                <p class="item-name">
                  {{ item.product?.name || "Producto no disponible" }} (x{{
                    item.quantity
                  }})
                </p>
                <div class="item-variants">
                  @for (variantKey of objectKeys(item.selectedVariants); track
                  variantKey) {
                  <span
                    >{{ variantKey }}:
                    <strong>{{
                      item.selectedVariants[variantKey]
                    }}</strong></span
                  >
                  }
                </div>
              </div>
              <p class="item-price">
                {{
                  item.price * item.quantity
                    | currency : "COP" : "symbol" : "1.0-0"
                }}
              </p>
            </div>
            }
          </div>

          <!-- Sección de Acciones (Solo visible si el pedido está en 'Procesando') -->
          @if (order.status === 'Procesando') {
          <div class="order-actions">
            <button
              (click)="openEditModal(order)"
              class="btn-secondary action-btn"
              appRipple
            >
              Editar Pedido
            </button>
            <button
              (click)="cancelOrder(order._id)"
              class="btn-danger action-btn"
              appRipple
            >
              Cancelar Pedido
            </button>
          </div>
          }
        </div>
      </div>
    </div>
    }
  </div>
  }

  <!-- Estado Vacío -->
  @else {
  <div class="empty-state">
    <h3>Aún no has realizado ningún pedido.</h3>
    <a routerLink="/products" class="explore-button" appRipple
      >Empezar a comprar</a
    >
  </div>
  }
</section>

<!-- 
==========================================================================
   MODAL DE EDICIÓN DE PEDIDO
   - Se muestra por encima de todo cuando isEditModalVisible() es true
========================================================================== 
-->
@if (isEditModalVisible() && editingOrder(); as order) {
<div class="modal-overlay" (click)="closeEditModal()"></div>
<div class="edit-modal-panel">
  <h2 class="modal-title">
    Editar Pedido #{{ order._id.slice(-6).toUpperCase() }}
  </h2>

  <div class="modal-content">
    @for (item of order.items; track item._id; let i = $index) {
    <div class="edit-item">
      @if (item.product?.images?.length > 0) {
      <img [src]="item.product.images[0]" class="item-image" />
      } @else {
      <div class="item-image placeholder"></div>
      }
      <div class="item-details">
        <p class="item-name">{{ item.product.name }}</p>
        <div class="item-variants">
          @for (variantKey of objectKeys(item.selectedVariants); track
          variantKey) {
          <span>{{ item.selectedVariants[variantKey] }}</span>
          }
        </div>
      </div>
      <div class="quantity-selector">
        <button
          (click)="updateItemQuantityInModal(i, -1)"
          class="quantity-btn"
          appRipple
        >
          -
        </button>
        <span class="quantity-value">{{ item.quantity }}</span>
        <button
          (click)="updateItemQuantityInModal(i, 1)"
          class="quantity-btn"
          appRipple
        >
          +
        </button>
      </div>
      <button (click)="removeItemInModal(i)" class="remove-btn" appRipple>
        <span class="material-symbols-outlined">delete</span>
      </button>
    </div>
    } @if (order.items.length === 0) {
    <p class="empty-modal-message">
      Has eliminado todos los productos. Si guardas los cambios, deberías
      cancelar el pedido.
    </p>
    }
  </div>

  <div class="modal-actions">
    <button (click)="closeEditModal()" class="btn-secondary" appRipple>
      Cancelar
    </button>
    <button (click)="saveOrderChanges()" class="btn-material" appRipple>
      Guardar Cambios
    </button>
  </div>
</div>
}
