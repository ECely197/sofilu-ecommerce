<div class="addresses-container">
  <header class="page-header">
    <h2>Mis Direcciones de Envío</h2>
    <button
      (click)="showAddForm()"
      class="btn-material"
      [disabled]="isFormVisible()"
      appRipple
    >
      <span class="material-symbols-outlined">add</span>
      Añadir Dirección
    </button>
  </header>

  <!-- FORMULARIO MODAL -->
  @if (isFormVisible()) {
  <div class="form-overlay" (click)="hideForm()"></div>
  <div class="form-panel">
    <h3>{{ editingAddressId() ? "Editar Dirección" : "Nueva Dirección" }}</h3>
    <form [formGroup]="addressForm" (ngSubmit)="handleSubmit()">
      <!-- CAMPOS DEL FORMULARIO -->
      <div class="form-grid">
        <div class="material-field">
          <input
            id="fullName"
            type="text"
            formControlName="fullName"
            class="material-input"
            placeholder=" "
          />
          <label for="fullName" class="material-label">Nombre Completo</label>
          @if(addressForm.get('fullName')?.touched &&
          addressForm.get('fullName')?.hasError('required')) {
          <p class="error-text">El nombre es requerido.</p>
          }
        </div>
        <div class="material-field">
          <input
            id="phone"
            type="tel"
            formControlName="phone"
            class="material-input"
            placeholder=" "
          />
          <label for="phone" class="material-label">Teléfono</label>
          @if(addressForm.get('phone')?.touched &&
          addressForm.get('phone')?.hasError('required')) {
          <p class="error-text">El teléfono es requerido.</p>
          }
        </div>
      </div>

      <!-- ¡NUEVO CAMPO DE EMAIL! -->
      <div class="material-field">
        <input
          id="email"
          type="email"
          formControlName="email"
          class="material-input"
          placeholder=" "
        />
        <label for="email" class="material-label">Email de Contacto</label>
        @if(addressForm.get('email')?.touched &&
        addressForm.get('email')?.invalid) {
        <p class="error-text">
          @if(addressForm.get('email')?.hasError('required')) {
          <span>El email es requerido.</span> }
          @if(addressForm.get('email')?.hasError('email')) {
          <span>Introduce un email válido.</span> }
        </p>
        }
      </div>

      <div class="material-field">
        <input
          id="streetAddress"
          type="text"
          formControlName="streetAddress"
          class="material-input"
          placeholder=" "
        />
        <label for="streetAddress" class="material-label"
          >Dirección (Calle, Número, Barrio)</label
        >
      </div>
      <div class="material-field">
        <input
          id="addressDetails"
          type="text"
          formControlName="addressDetails"
          class="material-input"
          placeholder=" "
        />
        <label for="addressDetails" class="material-label"
          >Detalles Adicionales (Apto, Torre, etc.)</label
        >
      </div>
      <div class="form-grid">
        <div class="material-field">
          <input
            id="department"
            type="text"
            formControlName="department"
            class="material-input"
            placeholder=" "
          />
          <label for="department" class="material-label">Departamento</label>
        </div>
        <div class="material-field">
          <input
            id="city"
            type="text"
            formControlName="city"
            class="material-input"
            placeholder=" "
          />
          <label for="city" class="material-label">Ciudad</label>
        </div>
      </div>
      <div class="material-field">
        <input
          id="postalCode"
          type="text"
          formControlName="postalCode"
          class="material-input"
          placeholder=" "
        />
        <label for="postalCode" class="material-label">Código Postal</label>
      </div>

      <!-- ACCIONES DEL FORMULARIO -->
      <div class="form-actions">
        <button
          type="button"
          (click)="hideForm()"
          class="btn-secondary"
          appRipple
        >
          Cancelar
        </button>
        <button
          type="submit"
          [disabled]="addressForm.invalid"
          class="btn-material"
          appRipple
        >
          Guardar Dirección
        </button>
      </div>
    </form>
  </div>
  }

  <!-- VISTA PRINCIPAL (LISTA DE DIRECCIONES) -->
  <div class="content-area">
    @if (isLoading()) {
    <p>Cargando direcciones...</p>
    } @else if (addresses().length > 0) {
    <div class="addresses-grid">
      @for (address of addresses(); track address._id) {
      <div class="address-card" [class.preferred]="address.isPreferred">
        @if(address.isPreferred) {
        <div class="preferred-badge">Preferida</div>
        }
        <h4>{{ address.fullName }}</h4>
        <p>{{ address.streetAddress }}, {{ address.addressDetails }}</p>
        <p>{{ address.city }}, {{ address.department }}</p>
        <p>{{ address.phone }}</p>
        <p>{{ address.email }}</p>
        <!-- Mostramos el email -->
        <div class="card-actions">
          <button (click)="showEditForm(address)">Editar</button>
          <button (click)="deleteAddress(address._id)">Eliminar</button>
          @if(!address.isPreferred) {
          <button (click)="setPreferred(address._id)">
            Marcar como preferida
          </button>
          }
        </div>
      </div>
      }
    </div>
    } @else {
    <div class="empty-state">
      <p>Aún no has guardado ninguna dirección.</p>
    </div>
    }
  </div>
</div>
