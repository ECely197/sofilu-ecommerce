<!-- Solo renderiza si hay datos en el servicio (modal abierto) -->
@if (productModalService.modalState(); as data) {
<!-- Overlay oscuro que cubre toda la página -->
<div class="modal-overlay" (click)="productModalService.close()"></div>

<!-- Panel del modal que se desliza desde abajo -->
<div class="modal-sheet" @flyInOut>
  <!-- Cabecera del Modal -->
  <header class="modal-header">
    <h2 class="modal-title">{{ data.title }}</h2>
    <button (click)="productModalService.close()" class="close-btn" appRipple>
      <span class="material-symbols-outlined">close</span>
    </button>
  </header>

  <!-- Barra de Filtros -->
  <div class="modal-filters" [formGroup]="filterForm">
    <!-- Filtro de Ordenamiento (siempre presente) -->
    <div class="filter-group">
      <label for="sortBySelect">Ordenar por:</label>
      <select id="sortBySelect" formControlName="sortBy" class="filter-select">
        <option value="relevance,desc">Relevancia</option>
        <option value="price,asc">Precio: de menor a mayor</option>
        <option value="price,desc">Precio: de mayor a menor</option>
        <option value="name,asc">Nombre: A-Z</option>
        <option value="name,desc">Nombre: Z-A</option>
      </select>
    </div>

    <!-- Filtros de Variantes (generados dinámicamente) -->
    @for(filter of availableFilters(); track filter.name) {
    <div class="filter-group">
      <label [for]="filter.name">{{ filter.name }}:</label>
      <select
        [id]="filter.name"
        [formControlName]="filter.name"
        class="filter-select"
      >
        <option value="all">Todos</option>
        @for(option of filter.options; track option.name) {
        <option [value]="option.name">{{ option.name }}</option>
        }
      </select>
    </div>
    }
  </div>

  <!-- Contenido Principal con Scroll -->
  <div class="modal-content">
    <div class="products-grid">
      <!-- Iteramos sobre los productos YA filtrados y ordenados -->
      @for(product of filteredProducts(); track product._id) {
      <app-product-card [product]="product"></app-product-card>
      } @empty {
      <!-- Mensaje que se muestra si no hay resultados -->
      <p class="empty-message">
        No se encontraron productos que coincidan con tus filtros.
      </p>
      }
    </div>
  </div>
</div>
}
