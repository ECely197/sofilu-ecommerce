<header class="sofilu-header" data-lenis-prevent>
  <!-- Contenedor Principal "Liquid Glass" -->
  <div class="header-pill">
    
    <!-- 1. LOGO (Izquierda) -->
    <div class="logo-wrapper">
      <a routerLink="/" class="logo-link">
        <img src="/sofilu-logo.svg" alt="Sofilu" class="logo-image" />
      </a>
    </div>

    <!-- 2. NAVEGACIÓN (Centro) -->
    <nav #navContainer class="desktop-nav">
      <!-- La píldora rosa animada (Fondo) -->
      <div #navPill class="nav-pill"></div>

      @for (item of navItems(); track item.id) {
      <div
        #navLink
        class="nav-item-wrapper"
        (mouseenter)="handleMouseEnter(item)"
        (mouseleave)="handleMouseLeave()"
      >
        <a
          [routerLink]="item.subCategories.length === 0 ? item.slug : null"
          [routerLinkActiveOptions]="{ exact: item.slug === '/' }"
          routerLinkActive="active"
          class="nav-link"
        >
          <span class="nav-text-original">{{ item.name }}</span>
          <span class="nav-text-reveal">{{ item.name }}</span>
        </a>

        <!-- MEGA MENÚ -->
        <div
          class="mega-menu-container"
          [class.is-active]="activeMenu()?.id === item.id"
        >
          @if (activeMenu()?.id === item.id) {
          <div class="mega-menu-card">
            <div
              class="sub-category-list"
              (mouseleave)="handleSubCategoryListLeave()"
            >
              <div #subCategoryPill class="hover-pill"></div>
              @for (sub of activeMenu()!.subCategories; track sub.id) {
              <a
                href="javascript:void(0)"
                (click)="handleSubCategoryClick($event, sub)"
                #subCategoryLink
                (mouseenter)="handleSubCategoryEnter(sub, $event)"
                [class.active]="activeSubCategory()?.id === sub.id"
                class="sub-category-link"
              >
                {{ sub.name }}
              </a>
              }
            </div>
            <div class="product-preview-container">
              @if (activeSubCategory(); as subCat) {
              <div class="product-preview-grid">
                @for (product of subCat.products; track product._id) {
                <a
                  [routerLink]="['/product', product._id]"
                  class="preview-product-card"
                  #previewCard
                >
                  <div class="preview-image-wrapper">
                    @if(product.images.length > 0) {
                    <img [src]="product.images[0]" [alt]="product.name" />
                    } @else {
                    <div class="image-placeholder"></div>
                    }
                  </div>
                  <p>{{ product.name }}</p>
                </a>
                }
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>
      }
    </nav>

    <!-- 3. ACCIONES (Derecha) -->
    <div class="header-right">
      <form class="search-form" (submit)="handleSearch($event, searchInput)">
        <span class="material-symbols-outlined search-icon">search</span>
        <input
          #searchInput
          type="text"
          placeholder="Buscar..."
          class="search-input"
        />
      </form>

      <button (click)="uiStateService.openWishlistFlyout()" class="icon-button">
        <span class="material-symbols-outlined">favorite</span>
        @if (wishlistService.wishlistProductIds().length > 0) {
        <span class="badge">{{ wishlistService.wishlistProductIds().length }}</span>
        }
      </button>

      <button (click)="uiStateService.openCartFlyout()" class="icon-button">
        <span class="material-symbols-outlined">shopping_bag</span>
        @if (cartService.totalItems() > 0) {
        <span class="badge">{{ cartService.totalItems() }}</span>
        }
      </button>

      @if (currentUser$ | async; as user) {
      <div class="profile-container">
        <button (click)="toggleProfileMenu($event)" class="profile-button">
          {{ user.email?.charAt(0)?.toUpperCase() }}
        </button>
        @if (isProfileMenuOpen()) {
        <div #profileMenu class="profile-menu">
          <div class="menu-header"><p>{{ user.email }}</p></div>
          <div class="menu-links">
            <a routerLink="/account" (click)="toggleProfileMenu()">Mi Cuenta</a>
            @if(isAdmin$ | async) { <a routerLink="/admin">Panel Admin</a> }
          </div>
          <div class="menu-footer">
            <button (click)="logout()" class="logout-button">Cerrar Sesión</button>
          </div>
        </div>
        }
      </div>
      } @else {
      <a routerLink="/login" class="login-button">Ingresar</a>
      }
    </div>
  </div>
</header>