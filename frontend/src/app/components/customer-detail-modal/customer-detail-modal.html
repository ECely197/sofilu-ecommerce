<!-- La condición @if principal controla la visibilidad del modal -->
@if (customerDetailModalService.activeCustomerId()) {
  <div class="modal-overlay" (click)="customerDetailModalService.close()"></div>

  <div class="modal-sheet" @flyInOut>
    <header class="modal-header">
      <h2 class="modal-title">Detalles del Cliente</h2>
      <button
        (click)="customerDetailModalService.close()"
        class="close-btn"
        appRipple
      >
        <span class="material-symbols-outlined">close</span>
      </button>
    </header>

    <div class="modal-content custom-scroll">
      <!-- 1. ESTADO DE CARGA -->
      @if (isLoading()) {
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Cargando detalles...</p>
        </div>
      }
      <!-- 2. NO ESTÁ CARGANDO -->
      @else {
        <!-- 3. VERIFICAMOS SI HAY DATOS (ANIDADO) -->
        @if (customerDetails(); as details) {
          <!-- HEADER PERFIL -->
          <div class="profile-header-card">
            <div class="avatar-large">
              {{ (details.firstName || details.email).charAt(0).toUpperCase() }}
            </div>
            <div class="profile-info">
              <h3>{{ details.firstName }} {{ details.lastName }}</h3>
              <p class="email">{{ details.email }}</p>
              <div class="badges">
                @if (details.isAdmin) {
                  <span class="badge admin">Administrador</span>
                }
                @if (details.isDisabled) {
                  <span class="badge disabled">Cuenta Bloqueada</span>
                }
                @if (!details.isAdmin && !details.isDisabled) {
                  <span class="badge active">Cliente Activo</span>
                }
              </div>
            </div>
          </div>

          <!-- ESTADÍSTICAS -->
          <div class="stats-grid">
            <div class="stat-box">
              <span class="label">Total Pedidos</span>
              <span class="value">{{ details.totalOrders }}</span>
            </div>
            <div class="stat-box">
              <span class="label">Total Gastado</span>
              <span class="value">{{
                details.totalSpent | currency: "COP" : "symbol" : "1.0-0"
              }}</span>
            </div>
          </div>

          <!-- INFORMACIÓN EXTRA -->
          <div class="detail-card">
            <h4>
              <span class="material-symbols-outlined">call</span> Contacto
            </h4>
            <p>{{ details.phone || "No registrado" }}</p>
          </div>

          <!-- CUPONES USADOS -->
          <div class="detail-card">
            <h4>
              <span class="material-symbols-outlined">local_activity</span>
              Historial de Cupones
            </h4>
            @if (details.usedCoupons.length > 0) {
              <div class="coupons-list">
                @for (coupon of details.usedCoupons; track coupon.code) {
                  <div class="coupon-item">
                    <div class="code">{{ coupon.code }}</div>
                    <div class="meta">
                      <span>{{ coupon.timesUsed }} usos</span>
                      <span class="saving"
                        >Ahorro:
                        {{
                          coupon.totalDiscount
                            | currency: "COP" : "symbol" : "1.0-0"
                        }}</span
                      >
                    </div>
                  </div>
                }
              </div>
            } @else {
              <p class="empty-text">No ha usado cupones aún.</p>
            }

            <!-- SECCIÓN: REGALAR CUPÓN -->
            <div class="detail-card highlight-card">
              <div class="card-header-flex">
                <h4>
                  <span class="material-symbols-outlined">redeem</span>
                  Asignar Beneficio
                </h4>
                <button
                  (click)="toggleCouponForm()"
                  class="btn-icon-small"
                  [class.active]="isCreatingCoupon()"
                  appRipple
                >
                  <span class="material-symbols-outlined">add</span>
                </button>
              </div>

              @if (isCreatingCoupon()) {
                <form
                  [formGroup]="couponForm"
                  (ngSubmit)="createExclusiveCoupon()"
                  class="mini-form"
                >
                  <div class="form-row">
                    <div class="field">
                      <label>Código</label>
                      <input
                        type="text"
                        formControlName="code"
                        class="glass-input code"
                      />
                    </div>
                    <div class="field">
                      <label>Valor</label>
                      <input
                        type="number"
                        formControlName="value"
                        class="glass-input"
                      />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="field">
                      <label>Tipo</label>
                      <select
                        formControlName="discountType"
                        class="glass-input"
                      >
                        <option value="Porcentaje">%</option>
                        <option value="Monto Fijo">$</option>
                      </select>
                    </div>
                    <div class="field">
                      <button
                        type="submit"
                        [disabled]="couponForm.invalid"
                        class="btn-primary-small"
                        appRipple
                      >
                        Crear
                      </button>
                    </div>
                  </div>
                </form>
              } @else {
                <p class="hint-text">
                  Crea un cupón exclusivo para este usuario.
                </p>
              }
            </div>
          </div>
        }
        <!-- 4. SI NO HAY DATOS (ERROR O NULL) -->
        @else {
          <div class="error-state">
            <p>No se pudo cargar la información del cliente.</p>
          </div>
        }
      }
    </div>
  </div>
}
