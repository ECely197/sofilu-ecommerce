<!-- La condición @if principal controla la visibilidad del modal -->
@if (customerDetailModalService.activeCustomerId()) {
<div class="modal-overlay" (click)="customerDetailModalService.close()"></div>

<div class="modal-sheet" @flyInOut>
  <header class="modal-header">
    <h2 class="modal-title">Detalles del Cliente</h2>
    <button (click)="customerDetailModalService.close()" class="close-btn">
      <span class="material-symbols-outlined">close</span>
    </button>
  </header>

  <div class="modal-content">
    <!-- 1. Primer @if interno: Maneja el estado de CARGA -->
    @if (isLoading()) {
    <p>Cargando detalles...</p>
    }
    <!-- 2. @else: Se ejecuta cuando la carga ha terminado -->
    @else {
    <!-- 3. Segundo @if interno: Verifica si tenemos datos y crea el alias 'details' -->
    @if (customerDetails(); as details) {
    <div class="details-grid">
      <!-- Tarjeta de Información Principal -->
      <div class="detail-card">
        <h3>{{ details.firstName }} {{ details.lastName }}</h3>
        <p>{{ details.email }}</p>
        <p>{{ details.phone || "Teléfono no especificado" }}</p>
        <div class="badges">
          <span class="badge" [class.admin]="details.isAdmin">{{
            details.isAdmin ? "Administrador" : "Cliente"
          }}</span>
          <span class="badge" [class.disabled]="details.isDisabled">{{
            details.isDisabled ? "Deshabilitado" : "Activo"
          }}</span>
        </div>
      </div>

      <!-- Tarjeta de Estadísticas de Compra -->
      <div class="detail-card">
        <div class="stat-item">
          <span>Pedidos Totales</span>
          <strong>{{ details.totalOrders }}</strong>
        </div>
        <div class="stat-item">
          <span>Gasto Total</span>
          <strong>{{
            details.totalSpent | currency : "COP" : "symbol" : "1.0-0"
          }}</strong>
        </div>
      </div>

      <!-- Tarjeta de Cupones Usados -->
      <div class="detail-card full-width">
        <h4>Cupones Utilizados</h4>
        @for(coupon of details.usedCoupons; track coupon.code) {
        <div class="coupon-item">
          <span class="coupon-code">{{ coupon.code }}</span>
          <span>Usado {{ coupon.timesUsed }} veces</span>
          <span
            >Descuento total:
            {{
              coupon.totalDiscount | currency : "COP" : "symbol" : "1.0-0"
            }}</span
          >
        </div>
        } @empty {
        <p class="empty-message">Este cliente no ha utilizado ningún cupón.</p>
        }
      </div>
    </div>
    }
    <!-- 4. @else del segundo @if: Si la carga terminó pero no hay datos -->
    @else {
    <p>No se pudieron cargar los detalles.</p>
    } }
  </div>
</div>
}
