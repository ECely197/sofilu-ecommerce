<!-- La condición @if principal controla la visibilidad del modal -->
@if (customerDetailModalService.activeCustomerId()) {
  <div class="modal-overlay" (click)="customerDetailModalService.close()"></div>

  <div class="modal-sheet" @flyInOut>
    <header class="modal-header">
      <h2 class="modal-title">Detalles del Cliente</h2>
      <button
        (click)="customerDetailModalService.close()"
        class="close-btn"
        appRipple
      >
        <span class="material-symbols-outlined">close</span>
      </button>
    </header>

    <div class="modal-content custom-scroll">
      <!-- 1. ESTADO DE CARGA -->
      @if (isLoading()) {
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Cargando detalles...</p>
        </div>
      }
      <!-- 2. NO ESTÁ CARGANDO -->
      @else {
        <!-- 3. VERIFICAMOS SI HAY DATOS (ANIDADO) -->
        @if (customerDetails(); as details) {
          <!-- HEADER PERFIL -->
          <div class="profile-header-card">
            <div class="avatar-large">
              {{ (details.firstName || details.email).charAt(0).toUpperCase() }}
            </div>
            <div class="profile-info">
              <h3>{{ details.firstName }} {{ details.lastName }}</h3>
              <p class="email">{{ details.email }}</p>
              <div class="badges">
                @if (details.isAdmin) {
                  <span class="badge admin">Administrador</span>
                }
                @if (details.isDisabled) {
                  <span class="badge disabled">Cuenta Bloqueada</span>
                }
                @if (!details.isAdmin && !details.isDisabled) {
                  <span class="badge active">Cliente Activo</span>
                }
              </div>
            </div>
          </div>

          <!-- ESTADÍSTICAS -->
          <div class="stats-grid">
            <div class="stat-box">
              <span class="label">Total Pedidos</span>
              <span class="value">{{ details.totalOrders }}</span>
            </div>
            <div class="stat-box">
              <span class="label">Total Gastado</span>
              <span class="value">{{
                details.totalSpent | currency: "COP" : "symbol" : "1.0-0"
              }}</span>
            </div>
          </div>

          <!-- INFORMACIÓN EXTRA -->
          <div class="detail-card">
            <h4>
              <span class="material-symbols-outlined">call</span> Contacto
            </h4>
            <p>{{ details.phone || "No registrado" }}</p>
          </div>

          <!-- CUPONES USADOS -->
          <div class="detail-card">
            <h4>
              <span class="material-symbols-outlined">confirmation_number</span>
              Cupones Asignados
            </h4>

            @if (activeCoupons().length > 0) {
              <div class="assigned-coupons-list isolate-scroll">
                @for (coupon of activeCoupons(); track coupon._id) {
                  <div class="mini-coupon-row">
                    <div class="coupon-left">
                      <span class="cp-code">{{ coupon.code }}</span>
                      <span class="cp-value">
                        {{
                          coupon.discountType === "Porcentaje"
                            ? coupon.value + "%"
                            : (coupon.value
                              | currency: "COP" : "symbol" : "1.0-0")
                        }}
                        OFF
                      </span>
                    </div>
                    <div class="coupon-right">
                      <span class="cp-date" [class.expired]="!coupon.isActive">
                        {{
                          coupon.expirationDate
                            ? (coupon.expirationDate | date: "shortDate")
                            : "Sin fecha"
                        }}
                      </span>
                      <!-- Podrías agregar botón de borrar aquí si quisieras -->
                    </div>
                  </div>
                }
              </div>
            } @else {
              <p class="empty-text small">
                No tiene cupones activos asignados.
              </p>
            }
          </div>

          <!-- 2. SECCIÓN CREAR (MEJORADA) -->
          <div class="detail-card highlight-card">
            <div class="card-header-flex">
              <div class="header-text">
                <span class="material-symbols-outlined icon-gift">redeem</span>
                <div>
                  <h4 class="no-margin">Asignar Nuevo Beneficio</h4>
                  <p class="sub-text">Crear cupón exclusivo</p>
                </div>
              </div>

              <!-- BOTÓN ARREGLADO -->
              <button
                (click)="toggleCouponForm()"
                class="btn-icon-round"
                [class.active]="isCreatingCoupon()"
                appRipple
              >
                <span class="material-symbols-outlined">add</span>
              </button>
            </div>

            @if (isCreatingCoupon()) {
              <form
                [formGroup]="couponForm"
                (ngSubmit)="createExclusiveCoupon()"
                class="mini-form"
              >
                <div class="form-row">
                  <div class="field">
                    <label>Código</label>
                    <input
                      type="text"
                      formControlName="code"
                      class="glass-input code"
                    />
                  </div>
                  <div class="field">
                    <label>Valor</label>
                    <input
                      type="number"
                      formControlName="value"
                      class="glass-input"
                    />
                  </div>
                </div>

                <div class="form-row">
                  <div class="field">
                    <label>Tipo</label>
                    <select formControlName="discountType" class="glass-input">
                      <option value="Porcentaje">% Porcentaje</option>
                      <option value="Monto Fijo">$ Fijo</option>
                    </select>
                  </div>
                  <div class="field btn-container">
                    <button
                      type="submit"
                      [disabled]="couponForm.invalid"
                      class="btn-primary-small"
                      appRipple
                    >
                      Confirmar
                    </button>
                  </div>
                </div>
              </form>
            }
          </div>
        }
        <!-- 4. SI NO HAY DATOS (ERROR O NULL) -->
        @else {
          <div class="error-state">
            <p>No se pudo cargar la información del cliente.</p>
          </div>
        }
      }
    </div>
  </div>
}
