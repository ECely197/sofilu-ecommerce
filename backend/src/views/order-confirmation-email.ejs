<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Confirmación de Pedido - Sofilu</title>
    <style>
      body {
        font-family: "Manrope", Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #faf3e9;
        color: #1a100e;
      }
      .container {
        max-width: 600px;
        margin: auto;
        background-color: white;
        border-radius: 16px;
        overflow: hidden;
      }
      .content {
        padding: 32px;
      }
      h1 {
        font-family: "Playfair Display", serif;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px 0;
        border-bottom: 1px solid #eae3d9;
        text-align: left;
        vertical-align: top;
      }
      .total-row {
        font-weight: bold;
        font-size: 1.2em;
      }
      .text-right {
        text-align: right;
      }
      .text-center {
        text-align: center;
      }
    </style>
  </head>
  <body
    style="
      margin: 0;
      padding: 0;
      background-color: #faf3e9;
      font-family: 'Manrope', Arial, sans-serif;
    "
  >
    <table width="100%" border="0" cellspacing="0" cellpadding="20">
      <tr>
        <td align="center">
          <div class="container">
            <!-- HEADER -->
            <div style="padding: 24px 0; text-align: center">
              <h1
                style="
                  font-family: 'Playfair Display', serif;
                  font-size: 24px;
                  color: #1a100e;
                  margin: 0;
                "
              >
                Sofilu
              </h1>
            </div>
            <!-- CUERPO -->
            <div class="content">
              <h1
                style="
                  font-family: 'Playfair Display', serif;
                  font-size: 28px;
                  color: #1a100e;
                  text-align: center;
                  margin: 0 0 16px 0;
                "
              >
                ¡Gracias por tu pedido, <%= order.customerInfo.name %>!
              </h1>
              <p
                style="
                  color: #945b51;
                  text-align: center;
                  margin: 0 0 32px 0;
                  line-height: 1.5;
                "
              >
                Hemos recibido tu pedido y lo estamos procesando. Recibirás una
                notificación cuando esté en camino.
              </p>

              <!-- TABLA DE PRODUCTOS -->
              <table>
                <thead>
                  <tr>
                    <th colspan="2">Producto</th>
                    <th class="text-center">Cantidad</th>
                    <th class="text-right">Precio</th>
                  </tr>
                </thead>
                <tbody>
                  <% order.items.forEach(item => { %>
                  <tr>
                    <td style="width: 80px">
                      <!--
                                        ¡CORRECCIÓN CLAVE!
                                        Verificamos si el array de imágenes existe y no está vacío.
                                      -->
                      <% if (item.product && item.product.images &&
                      item.product.images.length > 0) { %>
                      <img
                        src="<%= item.product.images[0] %>"
                        alt="<%= item.product.name %>"
                        width="64"
                        height="64"
                        style="border-radius: 8px; object-fit: cover"
                      />
                      <% } else { %>
                      <!-- Si no hay imagen, mostramos un placeholder. -->
                      <div
                        style="
                          width: 64px;
                          height: 64px;
                          background-color: #eae3d9;
                          border-radius: 8px;
                        "
                      ></div>
                      <% } %>
                    </td>
                    <td>
                      <p style="margin: 0; font-weight: 600; color: #1a100e">
                        <%= item.product.name %>
                      </p>
                      <p
                        style="
                          margin: 4px 0 0 0;
                          font-size: 12px;
                          color: #945b51;
                        "
                      >
                        <% for (const [key, value] of
                        Object.entries(item.selectedVariants || {})) { %>
                        <span><%= key %>: <strong><%= value %></strong></span
                        ><br />
                        <% } %>
                      </p>
                    </td>
                    <td class="text-center" style="color: #945b51">
                      <%= item.quantity %>
                    </td>
                    <td class="text-right" style="color: #1a100e">
                      $<%= item.price.toLocaleString('es-CO') %>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>

              <!-- TABLA DE TOTALES -->
              <% let subtotal = 0; order.items.forEach(item => { subtotal +=
              item.price * item.quantity; }); const shipping = 10000; %>
              <table style="margin-top: 24px">
                <tbody>
                  <tr>
                    <td style="color: #945b51">Subtotal</td>
                    <td class="text-right" style="color: #1a100e">
                      $<%= subtotal.toLocaleString('es-CO') %>
                    </td>
                  </tr>
                  <% if (order.discountAmount > 0) { %>
                  <tr>
                    <td style="color: #059669">
                      Descuento (<%= order.appliedCoupon %>)
                    </td>
                    <td class="text-right" style="color: #059669">
                      - $<%= order.discountAmount.toLocaleString('es-CO') %>
                    </td>
                  </tr>
                  <% } %>
                  <tr>
                    <td style="border-bottom: none; color: #945b51">Envío</td>
                    <td
                      class="text-right"
                      style="border-bottom: none; color: #1a100e"
                    >
                      $<%= shipping.toLocaleString('es-CO') %>
                    </td>
                  </tr>
                  <tr style="border-top: 2px solid #1a100e">
                    <td
                      style="
                        padding-top: 16px;
                        font-weight: bold;
                        font-size: 16px;
                        color: #1a100e;
                      "
                    >
                      Total
                    </td>
                    <td
                      class="text-right"
                      style="
                        padding-top: 16px;
                        font-weight: bold;
                        font-size: 16px;
                        color: #1a100e;
                      "
                    >
                      $<%= order.totalAmount.toLocaleString('es-CO') %>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </body>
</html>
